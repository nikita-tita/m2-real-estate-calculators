<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>М2 — Калькулятор: новостройка vs вторичка</title>
    <meta name="description" content="Калькулятор сравнения новостроек и вторичного жилья от М2. Сравните затраты на покупку, ремонт, сроки сдачи. Учитывает налоги и комиссии.">
    <meta name="keywords" content="новостройка вс вторичка, сравнение жилья, квартира М2, покупка квартиры, выбор квартиры, недвижимость">
    <meta property="og:title" content="М2 — Калькулятор: новостройка vs вторичка">
    <meta property="og:description" content="Калькулятор сравнения новостроек и вторичного жилья от М2. Сравните затраты на покупку, ремонт, сроки.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://m2-calculators-dfol1ftj8-nikita-tita-projects.vercel.app/new_vs_secondary_calculator.html">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="М2 — Калькулятор: новостройка vs вторичка">
    <meta name="twitter:description" content="Калькулятор сравнения новостроек и вторичного жилья от М2.">
    
    <!-- Favicon and Icons -->
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#4F2CD9">
    <link rel="apple-touch-icon" href="/icons/icon-192x192.png">
    <link rel="stylesheet" href="m2-theme.css">
    <link rel="stylesheet" href="m2-header.css">
    <link rel="stylesheet" href="m2-ui-components.css">
    <link rel="stylesheet" href="quick-fixes.css">
    <link rel="stylesheet" href="print-styles.css">
    <link rel="stylesheet" href="result-animations.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="pdf-export.js"></script>
    <script src="components.js"></script>
    <script src="advanced-ux-enhancements.js"></script>
    <script src="analytics.js"></script>
    <script src="auto-sliders.js"></script>
    <script src="loading-states.js"></script>
    <script src="input-validation.js"></script>
    <script src="keyboard-shortcuts.js"></script>
    <script src="result-animator.js"></script>
    <script src="m2-enhancements-loader.js"></script>
    <!-- Яндекс.Метрика -->
<script type="text/javascript" >
   (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
   m[i].l=1*new Date();
   for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
   k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
   (window, document, "script", "https://mc.yandex.ru/metrika/tag.js?id=104341432", "ym");
   ym(104341432, "init", {clickmap:true,trackLinks:true,accurateTrackBounce:true,webvisor:true,trackHash:true});
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/104341432" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
<!-- /Яндекс.Метрика -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8f9fa;
            color: #333;
            line-height: 1.4;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .logo {
            color: #4F2CD9 !important;
            font-size: 48px;
            font-weight: 700;
            color: #3416b6;
            margin-bottom: 12px;
        }

        .title {
            font-size: 32px;
            font-weight: 600;
            color: #333;
            margin-bottom: 12px;
        }

        .subtitle {
            font-size: 18px;
            color: #666;
        }

        .back-link {
            color: #4F2CD9 !important;
            color: #3416b6;
            text-decoration: none;
            font-size: 14px;
            margin-bottom: 20px;
            display: inline-block;
        }

        .back-link:hover {
            text-decoration: underline;
        }

        .calculator {
            display: grid;
            grid-template-columns: 1fr;
            gap: 32px;
            margin-bottom: 40px;
        }

        .inputs {
            background: white;
            border-radius: 16px;
            padding: 28px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        .section-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 24px;
            color: #333;
        }

        .input-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin-bottom: 24px;
        }

        .input-row:last-child {
            margin-bottom: 0;
        }

        /* Если в ряду нечётное количество элементов, последний занимает всю ширину */
        .input-row .input-group:only-child,
        .input-row .input-group:last-child:nth-child(odd) {
            grid-column: 1 / -1;
        }

        .input-group {
            margin-bottom: 24px;
        }

        .input-label {
            display: block;
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }

        .input-field {
            width: 100%;
            padding: 16px;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            font-size: 16px;
            background: white;
            transition: all 0.2s ease;
            appearance: textfield;
            will-change: border-color, box-shadow, transform;
        }

        .input-field:hover {
            border-color: #a599ff;
            box-shadow: 0 2px 8px rgba(52, 22, 182, 0.1);
        }

        .input-field:focus {
            outline: none;
            border-color: #3416b6;
            box-shadow: 0 4px 16px rgba(52, 22, 182, 0.15);
            transform: translateY(-1px);
        }

        .input-field::-webkit-outer-spin-button,
        .input-field::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .comparison-results {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 32px;
            margin-bottom: 40px;
        }

        .result-card {
            background: white;
            border-radius: 16px;
            padding: 28px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            transition: all 0.2s ease;
            will-change: transform, box-shadow;
        }
        
        .result-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 32px rgba(0,0,0,0.12);
        }

        .result-card.new-build {
            border-top: 4px solid #28a745;
        }

        .result-card.secondary {
            border-top: 4px solid #3416b6;
        }

        .card-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 24px;
        }

        .card-title.new-build {
            color: #28a745;
        }

        .card-title.secondary {
            color: #3416b6;
        }

        .result-item {
            margin-bottom: 24px;
            padding: 16px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .result-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        
        .result-item.primary-result {
            background: linear-gradient(135deg, #f8f9ff, #fff);
            border-radius: 12px;
            padding: 20px;
            margin: 0 -4px 24px -4px;
            border: 2px solid #e3f2fd;
            box-shadow: 0 4px 12px rgba(79,44,217,0.08);
        }

        .result-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .result-value {
            font-size: 24px;
            font-weight: 700;
            color: #333;
            letter-spacing: -0.5px;
            line-height: 1.2;
        }

        .result-value.primary {
            font-size: 32px;
            color: #3416b6;
            font-weight: 800;
            letter-spacing: -1px;
            text-shadow: 0 1px 2px rgba(52, 22, 182, 0.1);
            margin-bottom: 8px;
        }

        .result-value.success {
            color: #28a745;
        }

        .result-value.danger {
            color: #dc3545;
        }

        .pros-cons-section {
            background: white;
            border-radius: 16px;
            padding: 28px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            margin-bottom: 40px;
        }

        .pros-cons-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
            margin-top: 24px;
        }

        .pros-cons-column h3 {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 20px;
            text-align: center;
            padding: 12px;
            border-radius: 8px;
        }

        .new-build-header {
            background: #4F2CD9;
            color: white;
        }

        .secondary-header {
            background: #3416b6;
            color: white;
        }

        .pros-list {
            list-style: none;
            margin-bottom: 24px;
        }

        .pros-list li {
            padding: 8px 0;
            padding-left: 24px;
            position: relative;
            font-size: 14px;
            line-height: 1.4;
        }

        .pros-list li::before {
            content: '';
            position: absolute;
            left: 0;
            width: 16px;
            height: 16px;
            background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="%2328a745" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20,6 9,17 4,12"></polyline></svg>');
            background-repeat: no-repeat;
            background-position: center;
        }

        .cons-list {
            list-style: none;
        }

        .cons-list li {
            padding: 8px 0;
            padding-left: 24px;
            position: relative;
            font-size: 14px;
            line-height: 1.4;
        }

        .cons-list li::before {
            content: '';
            position: absolute;
            left: 0;
            width: 16px;
            height: 16px;
            background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="%23dc3545" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>');
            background-repeat: no-repeat;
            background-position: center;
        }

        .recommendation {
            background: linear-gradient(135deg, #3416b6, #2912a3);
            color: white;
            border-radius: 16px;
            padding: 32px;
            text-align: center;
            margin-bottom: 40px;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }
        
        .recommendation::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            transition: left 0.5s ease;
        }
        
        .recommendation:hover::before {
            left: 100%;
        }
        
        .recommendation:hover {
            transform: scale(1.02);
            box-shadow: 0 8px 32px rgba(52, 22, 182, 0.3);
        }

        .recommendation h2 {
            font-size: 28px;
            margin-bottom: 16px;
        }

        .recommendation p {
            font-size: 18px;
            opacity: 0.9;
            line-height: 1.5;
        }

        .action-buttons {
            display: flex;
            gap: 16px;
            justify-content: center;
            margin-top: 40px;
            flex-wrap: wrap;
        }

        .btn, .btn-primary {
            background: #4F2CD9;
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s ease;
            min-height: 48px;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            min-width: 44px;
        }

        .btn:hover, .btn-primary:hover {
            background: #3F23AE;
        }

        .btn-secondary {
            background: #797981;
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s ease;
            min-height: 48px;
        }

        .btn-secondary:hover {
            background: #5A5A61;
        }

        /* Parameter Groups - Enhanced Gestalt Principles */
        .parameter-group {
            background: white;
            border-radius: 16px;
            padding: 28px;
            margin-bottom: 32px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.08);
            border: 2px solid #f0f0f0;
            position: relative;
            transition: all 0.2s ease;
            will-change: transform, box-shadow, border-color;
        }
        
        .parameter-group:hover {
            border-color: #e3f2fd;
            box-shadow: 0 6px 24px rgba(79,44,217,0.12);
            transform: translateY(-2px);
        }
        
        .parameter-group::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            border-radius: 16px 16px 0 0;
            background: linear-gradient(90deg, var(--group-color, #007bff), transparent);
        }
        
        .parameter-group.financial::before {
            --group-color: #28a745;
        }
        
        .parameter-group.market::before {
            --group-color: #17a2b8;
        }
        
        .parameter-group.additional::before {
            --group-color: #6f42c1;
        }
        
        .parameter-group.expenses::before {
            --group-color: #fd7e14;
        }

        .group-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 24px;
            flex-wrap: wrap;
            gap: 12px;
            padding-bottom: 16px;
            border-bottom: 2px solid #f8f9fa;
        }

        .group-header h3 {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .group-description {
            font-size: 13px;
            color: #666;
            font-style: italic;
            flex-basis: 100%;
        }

        .add-parameter-btn {
            background: #4F2CD9;
            color: white;
            border: none;
            padding: 12px 16px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
            min-height: 44px; /* Fitts' Law: minimum 44px touch target */
            min-width: 44px;
        }

        .add-parameter-btn:hover {
            background: #3F23AE;
            transform: translateY(-1px);
        }

        /* Custom Parameters */
        .custom-parameters {
            margin-top: 16px;
        }

        .custom-parameter {
            display: flex;
            align-items: end;
            gap: 12px;
            margin-bottom: 16px;
            padding: 16px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .custom-parameter:last-child {
            margin-bottom: 0;
        }

        .parameter-type-select {
            min-width: 120px;
        }

        .parameter-type-select select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            background: white;
        }

        .custom-parameter .input-group {
            flex: 1;
            margin: 0;
        }

        .remove-parameter-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 12px 12px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            height: 44px; /* Fitts' Law: minimum 44px touch target */
            min-width: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .remove-parameter-btn:hover {
            background: #c82333;
        }

        .parameter-applies-to {
            font-size: 12px;
            color: #666;
            margin-top: 8px;
            padding: 4px 8px;
            background: #e3f2fd;
            border-radius: 4px;
            text-align: center;
        }

        /* Screen reader only content */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        .quick-btn {
            background: #4F2CD9;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s ease;
            min-height: 44px;
        }

        .quick-btn:hover, .quick-btn.active {
            background: #3F23AE;
        }

        @media (max-width: 768px) {
            .comparison-results, .pros-cons-grid, .input-row {
                grid-template-columns: 1fr;
                gap: 24px;
            }

            .container {
                padding: 24px 16px;
            }

            .inputs, .result-card, .pros-cons-section, .recommendation {
                padding: 24px;
            }

            .action-buttons {
                flex-direction: column;
                align-items: center;
            }

            .btn {
                width: 100%;
                justify-content: center;
            }
        }
        @media (max-width: 768px) {
            .container { padding: 20px 15px; }
            .input-field, .input-field select { font-size: 16px; padding: 14px; min-height: 48px; }
            .quick-btn { padding: 12px 16px; font-size: 14px; min-height: 44px; }
            .btn, .btn-primary, .btn-secondary { min-height: 48px; padding: 16px 24px; font-size: 16px; }
            .grid-2 { grid-template-columns: 1fr !important; }
            .results-grid { grid-template-columns: 1fr !important; }
            table { display: block; overflow-x: auto; -webkit-overflow-scrolling: touch; }
        }
        @media (max-width: 375px) {
            .container { padding: 12px 8px; }
            .header h1, .title { font-size: 24px; }
        }
    </style>
</head>
<body>
    <!-- M2.ru Header -->
    <header class="m2-header">
        <div class="m2-header-content">
            <!-- Logo -->
            <div class="m2-header-logo">
                <a href="https://m2.ru/" target="_blank" rel="noopener">
                    <svg width="58" height="52" viewBox="0 0 58 52" fill="none">
                        <path fill-rule="evenodd" clip-rule="evenodd" d="M17 0H58V41H41V52H0V11H17V0Z" fill="#3216B5"></path>
                        <path d="M44.157 27.392V24.6531H37.5997V24.6298C39.9124 23.6013 43.9483 21.8471 43.9483 18.1997C43.9483 15.3184 41.5538 12.8572 38.1712 12.8572C34.7887 12.8572 33.0611 15.1883 32.3001 17.2899L34.8036 18.2698C35.3685 16.5165 36.363 15.4468 38.1945 15.4468C39.794 15.4468 41.1117 16.6404 40.9809 18.223C40.8122 20.2646 38.6293 21.7447 36.6206 22.8487C35.0867 23.692 32.7112 24.889 32.7112 24.889V27.392H44.157Z" fill="white"></path>
                        <path d="M12.0522 24.663V38.3574H15.0083V28.0866L19.2383 38.3574H21.4807L25.6344 28.0866V38.3574H28.6158V24.663H24.3094L20.334 34.4851L16.3333 24.663H12.0522Z" fill="white"></path>
                    </svg>
                </a>
            </div>

            <!-- Navigation -->
            <nav class="m2-header-nav">
                <div class="m2-header-nav-menu">
                    <a href="https://m2.ru/moskva/novostroyki/" target="_blank" rel="noopener" class="m2-header-nav-link">Новостройки</a>
                    <a href="https://m2.ru/ipoteka/" target="_blank" rel="noopener" class="m2-header-nav-link">Ипотека</a>
                    <a href="https://m2.ru/services/deal/" target="_blank" rel="noopener" class="m2-header-nav-link">Сделка</a>
                    <a href="index.html" class="m2-header-nav-link m2-header-nav-link-active">Калькуляторы</a>
                </div>
            </nav>

            <!-- User Actions -->
            <div class="m2-header-actions">
                <a href="https://m2.ru/login/" target="_blank" rel="noopener" class="m2-header-login-btn">Войти</a>
            </div>
        </div>
    </header>

    <div class="container">
        <a href="index.html" class="back-link">← Вернуться к калькуляторам</a>

        <div class="header">
            <h1 class="title">Новостройка vs Вторичка</h1>
            <p class="subtitle">Сравните полную стоимость владения и выберите оптимальный вариант</p>
        </div>

        <main class="calculator" role="main">
            <section class="inputs" aria-labelledby="params-title">
                <h2 id="params-title" class="section-title">Параметры сравнения</h2>
                
                <!-- Группа основных расходов -->
                <div class="parameter-group expenses">
                    <div class="group-header">
                        <h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 8px; vertical-align: middle;"><circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><line x1="12" y1="17" x2="12.01" y2="17"></line></svg> Основные расходы</h3>
                        <span class="group-description">Стоимость покупки и подготовки к заселению</span>
                    </div>
                    
                    <div class="input-row">
                        <div class="input-group">
                            <label class="input-label" for="newBuildPrice">Цена новостройки</label>
                            <input type="number" id="newBuildPrice" class="input-field" value="12000000" min="1000000" max="100000000" step="100000">
                        </div>
                        <div class="input-group">
                            <label class="input-label" for="secondaryPrice">Цена вторички</label>
                            <input type="number" id="secondaryPrice" class="input-field" value="15000000" min="1000000" max="100000000" step="100000">
                        </div>
                    </div>
                    
                    <div class="input-row">
                        <div class="input-group">
                            <label class="input-label" for="newBuildRenovation">Ремонт новостройки</label>
                            <input type="number" id="newBuildRenovation" class="input-field" value="2000000" min="0" max="10000000" step="50000">
                        </div>
                        <div class="input-group">
                            <label class="input-label" for="secondaryRenovation">Ремонт вторички</label>
                            <input type="number" id="secondaryRenovation" class="input-field" value="1500000" min="0" max="10000000" step="50000">
                        </div>
                    </div>
                </div>

                <!-- Группа дополнительных расходов -->
                <div class="parameter-group additional">
                    <div class="group-header">
                        <h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 8px; vertical-align: middle;"><path d="M9 11H4a2 2 0 0 0-2 2v3a2 2 0 0 0 2 2h5l2 2v-9a2 2 0 0 0-2-2z"></path><path d="M14 9a2 2 0 0 1 2-2h5a2 2 0 0 1 2 2v3a2 2 0 0 1-2 2h-5l-2 2V9z"></path></svg> Дополнительные расходы</h3>
                        <span class="group-description">Юридические и другие сопутствующие расходы</span>
                    </div>
                    
                    <div class="input-row">
                        <div class="input-group">
                            <label class="input-label" for="newBuildDelivery">Срок сдачи новостройки, мес</label>
                            <input type="number" id="newBuildDelivery" class="input-field" value="24" min="6" max="60" step="1">
                        </div>
                        <div class="input-group">
                            <label class="input-label" for="legalCosts">Юридические расходы</label>
                            <input type="number" id="legalCosts" class="input-field" value="200000" min="0" max="1000000" step="10000">
                        </div>
                    </div>
                </div>

                <!-- Конструктор дополнительных параметров -->
                <div class="parameter-group additional">
                    <div class="group-header">
                        <h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 8px; vertical-align: middle;"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1 1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82v0a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg> Дополнительные параметры</h3>
                        <span class="group-description">Добавьте свои параметры для более точного расчета</span>
                        <button type="button" class="add-parameter-btn" onclick="addCustomParameter()" aria-describedby="add-param-desc">
                            + Добавить параметр
                        </button>
                        <div id="add-param-desc" class="sr-only">Добавить новый параметр для сравнения</div>
                    </div>
                    
                    <div id="customParameters" class="custom-parameters">
                        <!-- Динамически добавляемые параметры будут здесь -->
                    </div>
                </div>

                <!-- Группа финансовых параметров -->
                <div class="parameter-group financial">
                    <div class="group-header">
                        <h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 8px; vertical-align: middle;"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg> Финансовые параметры</h3>
                        <span class="group-description">Параметры ипотечного кредитования и дополнительные расходы</span>
                    </div>
                    
                    <div class="input-row">
                        <div class="input-group">
                            <label class="input-label" for="currentRent">Текущая аренда жилья, мес</label>
                            <input type="number" id="currentRent" class="input-field" value="80000" min="0" max="500000" step="5000">
                        </div>
                        <div class="input-group">
                            <label class="input-label" for="mortgageRate">Ставка по ипотеке, %</label>
                            <input type="number" id="mortgageRate" class="input-field" value="12" min="1" max="30" step="0.1">
                        </div>
                    </div>

                    <div class="input-row">
                        <div class="input-group">
                            <label class="input-label" for="downPayment">Первоначальный взнос, %</label>
                            <input type="number" id="downPayment" class="input-field" value="30" min="10" max="100" step="5">
                        </div>
                        <div class="input-group">
                            <label class="input-label" for="loanTerm">Срок кредита, лет</label>
                            <input type="number" id="loanTerm" class="input-field" value="20" min="5" max="30" step="1">
                        </div>
                    </div>
                </div>

                <!-- Группа рыночных параметров -->
                <div class="parameter-group market">
                    <div class="group-header">
                        <h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 8px; vertical-align: middle;"><path d="M3 3l18 18M8 12l4-4 4 4M4 8l8-8 8 8"></path></svg> Рыночные параметры</h3>
                        <span class="group-description">Прогноз роста стоимости недвижимости</span>
                    </div>
                    
                    <div class="input-row">
                        <div class="input-group">
                            <label class="input-label" for="priceGrowthNew">Рост цен новостроек, % в год</label>
                            <input type="number" id="priceGrowthNew" class="input-field" value="8" min="0" max="30" step="0.5">
                        </div>
                        <div class="input-group">
                            <label class="input-label" for="priceGrowthSecondary">Рост цен вторички, % в год</label>
                            <input type="number" id="priceGrowthSecondary" class="input-field" value="5" min="0" max="30" step="0.5">
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <section class="comparison-results" aria-labelledby="results-title">
            <h2 id="results-title" class="sr-only">Результаты сравнения</h2>
            <article class="result-card new-build" aria-labelledby="new-build-title">
                <h3 id="new-build-title" class="card-title new-build">Новостройка</h3>
                
                <div class="result-item primary-result">
                    <div class="result-label">Итоговая стоимость</div>
                    <div class="result-value primary" id="newBuildTotal">14 920 000 ₽</div>
                </div>

                <div class="result-item">
                    <div class="result-label">Ежемесячный платеж</div>
                    <div class="result-value" id="newBuildPayment">92 400 ₽</div>
                </div>

                <div class="result-item">
                    <div class="result-label">Затраты до заселения</div>
                    <div class="result-value" id="newBuildWaiting">1 920 000 ₽</div>
                </div>

                <div class="result-item">
                    <div class="result-label">Стоимость к моменту сдачи</div>
                    <div class="result-value success" id="newBuildFuture">14 080 000 ₽</div>
                </div>
            </article>

            <article class="result-card secondary" aria-labelledby="secondary-title">
                <h3 id="secondary-title" class="card-title secondary">Вторичка</h3>
                
                <div class="result-item primary-result">
                    <div class="result-label">Итоговая стоимость</div>
                    <div class="result-value primary" id="secondaryTotal">16 500 000 ₽</div>
                </div>

                <div class="result-item">
                    <div class="result-label">Ежемесячный платеж</div>
                    <div class="result-value" id="secondaryPayment">115 500 ₽</div>
                </div>

                <div class="result-item">
                    <div class="result-label">Первоначальные затраты</div>
                    <div class="result-value" id="secondaryUpfront">6 000 000 ₽</div>
                </div>

                <div class="result-item">
                    <div class="result-label">Готова к проживанию</div>
                    <div class="result-value success" id="secondaryReady">Сразу</div>
                </div>
            </article>
        </div>

        <!-- Детализация расчетов -->
        <div class="calculation-details" style="margin: 40px 0; background: white; border-radius: 12px; padding: 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
            <div class="details-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 2px solid #f0f0f0; padding-bottom: 15px;">
                <h3 style="margin: 0; color: #3416b6; font-size: 24px;"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 8px; vertical-align: middle;"><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></svg> Как мы считаем</h3>
                <button type="button" onclick="toggleCalculationDetails()" style="background: #3416b6; color: white; border: none; padding: 12px 20px; border-radius: 6px; cursor: pointer; font-size: 14px; min-height: 44px; min-width: 44px;">
                    Показать расчеты
                </button>
            </div>
            
            <div id="detailsContent" style="display: none;">
                <div class="calculation-steps" id="calculationSteps"></div>
            </div>
        </div>

        <section class="pros-cons-section" aria-labelledby="pros-cons-title">
            <h2 id="pros-cons-title" class="section-title">Преимущества и недостатки</h2>
            <div class="pros-cons-grid">
                <div class="pros-cons-column">
                    <h3 class="new-build-header">Новостройка</h3>
                    <h4 style="margin-bottom: 16px; color: #28a745;">Плюсы:</h4>
                    <ul class="pros-list">
                        <li>Ниже цена за квадратный метр</li>
                        <li>Современная планировка и технологии</li>
                        <li>Не требует ремонта</li>
                        <li>Возможность налогового вычета</li>
                        <li>Рост стоимости в процессе строительства</li>
                        <li>Новая инфраструктура района</li>
                    </ul>
                    <h4 style="margin-bottom: 16px; color: #dc3545;">Минусы:</h4>
                    <ul class="cons-list">
                        <li>Риск задержки сдачи объекта</li>
                        <li>Затраты на аренду жилья до сдачи</li>
                        <li>Неразвитая инфраструктура</li>
                        <li>Возможные проблемы с застройщиком</li>
                        <li>Отсутствие сложившегося сообщества</li>
                    </ul>
                </div>

                <div class="pros-cons-column">
                    <h3 class="secondary-header">Вторичка</h3>
                    <h4 style="margin-bottom: 16px; color: #28a745;">Плюсы:</h4>
                    <ul class="pros-list">
                        <li>Готова к проживанию сразу</li>
                        <li>Развитая инфраструктура</li>
                        <li>Проверенное качество дома</li>
                        <li>Сложившееся сообщество жильцов</li>
                        <li>Возможность осмотра перед покупкой</li>
                        <li>Стабильные цены на рынке</li>
                    </ul>
                    <h4 style="margin-bottom: 16px; color: #dc3545;">Минусы:</h4>
                    <ul class="cons-list">
                        <li>Выше цена за квадратный метр</li>
                        <li>Требует ремонта или обновления</li>
                        <li>Устаревшие коммуникации</li>
                        <li>Ограниченный выбор планировок</li>
                        <li>Износ дома и придомовой территории</li>
                    </ul>
                </div>
            </div>
        </div>

        <section class="recommendation" id="recommendation" role="region" aria-labelledby="recommendation-title">
            <h2 id="recommendation-title">Рекомендация</h2>
            <p id="recommendationText" aria-live="polite">Новостройка выгоднее на 1 580 000 ₽ с учетом всех расходов</p>
        </section>

        <!-- Action Buttons -->
        <div class="action-buttons">
            <button class="btn btn-primary" onclick="exportToPDF()">
                Экспорт в PDF
            </button>
            <button class="btn btn-primary" onclick="exportToExcel()" style="background: #4F2CD9;">
                📊 Excel
            </button>
            <button class="btn btn-secondary" onclick="resetCalculator()">
                Сбросить
            </button>
        </div>
    </div>

    <script>
        // Debounce function for performance optimization
        function debounce(func, wait = 150) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function formatNumber(num) {
            return new Intl.NumberFormat('ru-RU').format(Math.round(num));
        }

        function calculateMortgagePayment(loanAmount, annualRate, termYears) {
            const monthlyRate = annualRate / 100 / 12;
            const numPayments = termYears * 12;
            
            if (monthlyRate === 0) {
                return loanAmount / numPayments;
            }
            
            const payment = loanAmount * (monthlyRate * Math.pow(1 + monthlyRate, numPayments)) / 
                           (Math.pow(1 + monthlyRate, numPayments) - 1);
            
            return payment;
        }

        function calculateComparison() {
            if (typeof ym !== 'undefined') {
                ym(104341432, 'reachGoal', 'calculation_made', {calculator: 'new_vs_secondary'});
            }
            const newBuildPrice = parseFloat(document.getElementById('newBuildPrice').value) || 0;
            const secondaryPrice = parseFloat(document.getElementById('secondaryPrice').value) || 0;
            const newBuildDelivery = parseFloat(document.getElementById('newBuildDelivery').value) || 0;
            const newBuildRenovation = parseFloat(document.getElementById('newBuildRenovation').value) || 0;
            const secondaryRenovation = parseFloat(document.getElementById('secondaryRenovation').value) || 0;
            const legalCosts = parseFloat(document.getElementById('legalCosts').value) || 0;
            const currentRent = parseFloat(document.getElementById('currentRent').value) || 0;
            const mortgageRate = parseFloat(document.getElementById('mortgageRate').value) || 0;
            const priceGrowthNew = parseFloat(document.getElementById('priceGrowthNew').value) || 0;
            const priceGrowthSecondary = parseFloat(document.getElementById('priceGrowthSecondary').value) || 0;
            const downPaymentPercent = parseFloat(document.getElementById('downPayment').value) || 0;
            const loanTerm = parseFloat(document.getElementById('loanTerm').value) || 0;
            
            // Получаем суммы кастомных параметров
            const customParams = getCustomParametersTotal();

            // Расчеты для новостройки
            const waitingCost = currentRent * newBuildDelivery; // затраты на аренду во время ожидания

            // ИСПРАВЛЕНО: Цена по ДДУ фиксируется при покупке и НЕ растёт до сдачи
            // Покупная цена остаётся той же
            const purchasePrice = newBuildPrice;

            // Рыночная стоимость после сдачи (для оценки инвестиционной привлекательности)
            // Рост начинается только ПОСЛЕ сдачи объекта
            const monthsAfterDelivery = Math.max(0, 12 - newBuildDelivery); // Сколько месяцев прошло после сдачи за первый год
            const newBuildMarketValue = purchasePrice * Math.pow(1 + priceGrowthNew / 100, monthsAfterDelivery / 12);

            const newBuildDownPayment = purchasePrice * (downPaymentPercent / 100);
            const newBuildLoanAmount = purchasePrice - newBuildDownPayment;
            const newBuildMonthlyPayment = calculateMortgagePayment(newBuildLoanAmount, mortgageRate, loanTerm);

            const newBuildTotal = purchasePrice + newBuildRenovation + legalCosts + waitingCost + customParams.newTotal;

            // Расчеты для вторички  
            const secondaryTotalPrice = secondaryPrice + secondaryRenovation + legalCosts + customParams.secondaryTotal;
            const secondaryDownPayment = secondaryTotalPrice * (downPaymentPercent / 100);
            const secondaryLoanAmount = secondaryTotalPrice - secondaryDownPayment;
            const secondaryMonthlyPayment = calculateMortgagePayment(secondaryLoanAmount, mortgageRate, loanTerm);

            // Обновление результатов новостройки
            document.getElementById('newBuildTotal').textContent = formatNumber(newBuildTotal) + ' ₽';
            document.getElementById('newBuildPayment').textContent = formatNumber(newBuildMonthlyPayment) + ' ₽';
            document.getElementById('newBuildWaiting').textContent = formatNumber(waitingCost) + ' ₽';
            document.getElementById('newBuildFuture').textContent = formatNumber(newBuildMarketValue) + ' ₽';

            // Обновление результатов вторички
            document.getElementById('secondaryTotal').textContent = formatNumber(secondaryTotalPrice) + ' ₽';
            document.getElementById('secondaryPayment').textContent = formatNumber(secondaryMonthlyPayment) + ' ₽';
            document.getElementById('secondaryUpfront').textContent = formatNumber(secondaryDownPayment + secondaryRenovation + legalCosts + customParams.secondaryTotal) + ' ₽';
            document.getElementById('secondaryReady').textContent = 'Сразу';

            // Рекомендация
            const difference = secondaryTotalPrice - newBuildTotal;
            let recommendationText = '';
            let recommendationColor = '';

            if (difference > 0) {
                recommendationText = `Новостройка выгоднее на ${formatNumber(difference)} ₽ с учетом всех расходов`;
                recommendationColor = 'linear-gradient(135deg, #28a745, #20c997)';
            } else {
                recommendationText = `Вторичка выгоднее на ${formatNumber(Math.abs(difference))} ₽ с учетом всех расходов`;
                recommendationColor = 'linear-gradient(135deg, #007bff, #0056b3)';
            }

            document.getElementById('recommendationText').textContent = recommendationText;
            document.getElementById('recommendation').style.background = recommendationColor;
            
            // Обновляем детализацию расчетов
            updateCalculationDetails();
        }

        function resetCalculator() {
            document.getElementById('newBuildPrice').value = 12000000;
            document.getElementById('secondaryPrice').value = 15000000;
            document.getElementById('newBuildDelivery').value = 24;
            document.getElementById('newBuildRenovation').value = 1500000;
            document.getElementById('secondaryRenovation').value = 800000;
            document.getElementById('legalCosts').value = 300000;
            document.getElementById('currentRent').value = 80000;
            document.getElementById('mortgageRate').value = 12;
            document.getElementById('priceGrowthNew').value = 8;
            document.getElementById('priceGrowthSecondary').value = 5;
            document.getElementById('downPayment').value = 30;
            document.getElementById('loanTerm').value = 20;
            
            // Удаляем все кастомные параметры
            const customParameters = document.getElementById('customParameters');
            customParameters.innerHTML = '';
            customParameterCount = 0;
            
            debouncedCalculateComparison();
        }

        // Конструктор дополнительных параметров
        let customParameterCount = 0;

        function addCustomParameter() {
            customParameterCount++;
            const customParameters = document.getElementById('customParameters');
            
            const parameterId = `customParam_${customParameterCount}`;
            
            const parameterDiv = document.createElement('div');
            parameterDiv.className = 'custom-parameter';
            parameterDiv.id = `customParameter_${customParameterCount}`;
            
            parameterDiv.innerHTML = `
                <div class="parameter-type-select">
                    <label class="input-label">Тип</label>
                    <select onchange="updateParameterType(${customParameterCount})">
                        <option value="both">Оба варианта</option>
                        <option value="new">Только новостройка</option>
                        <option value="secondary">Только вторичка</option>
                    </select>
                </div>
                <div class="input-group">
                    <label class="input-label" for="${parameterId}_name">Название параметра</label>
                    <input type="text" id="${parameterId}_name" class="input-field" placeholder="Например: Мебель" onchange="debouncedCalculateComparison()">
                </div>
                <div class="input-group">
                    <label class="input-label" for="${parameterId}_new">Новостройка</label>
                    <input type="number" id="${parameterId}_new" class="input-field" value="0" min="0" step="1000" onchange="debouncedCalculateComparison()">
                </div>
                <div class="input-group">
                    <label class="input-label" for="${parameterId}_secondary">Вторичка</label>
                    <input type="number" id="${parameterId}_secondary" class="input-field" value="0" min="0" step="1000" onchange="debouncedCalculateComparison()">
                </div>
                <button type="button" class="remove-parameter-btn" onclick="removeCustomParameter(${customParameterCount})" title="Удалить параметр">
                    ×
                </button>
            `;
            
            customParameters.appendChild(parameterDiv);
            
            // Сразу пересчитываем после добавления
            debouncedCalculateComparison();
        }

        function removeCustomParameter(parameterId) {
            const parameterDiv = document.getElementById(`customParameter_${parameterId}`);
            if (parameterDiv) {
                parameterDiv.remove();
                debouncedCalculateComparison();
            }
        }

        function updateParameterType(parameterId) {
            const select = document.querySelector(`#customParameter_${parameterId} select`);
            const newInput = document.getElementById(`customParam_${parameterId}_new`);
            const secondaryInput = document.getElementById(`customParam_${parameterId}_secondary`);
            
            const type = select.value;
            
            // Обновляем состояние полей в зависимости от типа
            switch(type) {
                case 'new':
                    newInput.disabled = false;
                    secondaryInput.disabled = true;
                    secondaryInput.value = 0;
                    newInput.style.opacity = '1';
                    secondaryInput.style.opacity = '0.5';
                    break;
                case 'secondary':
                    newInput.disabled = true;
                    secondaryInput.disabled = false;
                    newInput.value = 0;
                    newInput.style.opacity = '0.5';
                    secondaryInput.style.opacity = '1';
                    break;
                case 'both':
                default:
                    newInput.disabled = false;
                    secondaryInput.disabled = false;
                    newInput.style.opacity = '1';
                    secondaryInput.style.opacity = '1';
                    break;
            }
            
            debouncedCalculateComparison();
        }

        function getCustomParametersTotal() {
            let newTotal = 0;
            let secondaryTotal = 0;
            
            for (let i = 1; i <= customParameterCount; i++) {
                const newInput = document.getElementById(`customParam_${i}_new`);
                const secondaryInput = document.getElementById(`customParam_${i}_secondary`);
                
                if (newInput && !newInput.disabled) {
                    newTotal += parseFloat(newInput.value) || 0;
                }
                if (secondaryInput && !secondaryInput.disabled) {
                    secondaryTotal += parseFloat(secondaryInput.value) || 0;
                }
            }
            
            return { newTotal, secondaryTotal };
        }

        function exportToPDF() {
            if (typeof ym !== 'undefined') {
                ym(104341432, 'reachGoal', 'pdf_export', {calculator: 'new_vs_secondary'});
            }
            // Use the improved PDF export system
            exportNewVsSecondaryToPDF();
        }

        function exportToExcel() {
            if (typeof ym !== 'undefined') {
                ym(104341432, 'reachGoal', 'excel_export', {calculator: 'new_vs_secondary'});
            }
            let csvContent = '\uFEFF';
            csvContent += 'М2 - Новостройка vs Вторичка\n';
            csvContent += `Дата расчёта,${new Date().toLocaleString('ru-RU')}\n\n`;
            // Add calculator-specific data here based on inputs
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.setAttribute('href', URL.createObjectURL(blob));
            link.setAttribute('download', `m2_new_vs_secondary_${new Date().getTime()}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showNotification('Excel файл успешно загружен', 'success');
        }

        // Функции для детализации расчетов
        function toggleCalculationDetails() {
            const content = document.getElementById('detailsContent');
            const button = content.previousElementSibling.querySelector('button');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                button.textContent = 'Скрыть расчеты';
                updateCalculationDetails();
            } else {
                content.style.display = 'none';
                button.textContent = 'Показать расчеты';
            }
        }

        function updateCalculationDetails() {
            const newBuildPrice = parseFloat(document.getElementById('newBuildPrice').value) || 0;
            const secondaryPrice = parseFloat(document.getElementById('secondaryPrice').value) || 0;
            const newBuildDelivery = parseFloat(document.getElementById('newBuildDelivery').value) || 0;
            const newBuildRenovation = parseFloat(document.getElementById('newBuildRenovation').value) || 0;
            const secondaryRenovation = parseFloat(document.getElementById('secondaryRenovation').value) || 0;
            const legalCosts = parseFloat(document.getElementById('legalCosts').value) || 0;
            const currentRent = parseFloat(document.getElementById('currentRent').value) || 0;
            const mortgageRate = parseFloat(document.getElementById('mortgageRate').value) || 0;
            const priceGrowthNew = parseFloat(document.getElementById('priceGrowthNew').value) || 0;
            const priceGrowthSecondary = parseFloat(document.getElementById('priceGrowthSecondary').value) || 0;
            const downPayment = parseFloat(document.getElementById('downPayment').value) || 0;
            const loanTerm = parseFloat(document.getElementById('loanTerm').value) || 0;

            // Получаем кастомные параметры
            const customParams = getCustomParametersTotal();
            
            const stepsContainer = document.getElementById('calculationSteps');
            
            // Расчеты для новостройки
            const newLoanAmount = (newBuildPrice + newBuildRenovation + legalCosts + customParams.newTotal) * (1 - downPayment / 100);
            const newDownPaymentAmount = (newBuildPrice + newBuildRenovation + legalCosts + customParams.newTotal) * (downPayment / 100);
            const newMonthlyPayment = calculateMortgagePayment(newLoanAmount, mortgageRate, loanTerm);
            const newWaitingCosts = currentRent * newBuildDelivery;
            const newTotalCost = newBuildPrice + newBuildRenovation + legalCosts + customParams.newTotal + newWaitingCosts;
            const newFutureValue = newBuildPrice * Math.pow(1 + priceGrowthNew / 100, newBuildDelivery / 12);

            // Расчеты для вторички
            const secondaryLoanAmount = (secondaryPrice + secondaryRenovation + legalCosts + customParams.secondaryTotal) * (1 - downPayment / 100);
            const secondaryDownPaymentAmount = (secondaryPrice + secondaryRenovation + legalCosts + customParams.secondaryTotal) * (downPayment / 100);
            const secondaryMonthlyPayment = calculateMortgagePayment(secondaryLoanAmount, mortgageRate, loanTerm);
            const secondaryTotalCost = secondaryPrice + secondaryRenovation + legalCosts + customParams.secondaryTotal;

            stepsContainer.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 40px; margin-top: 20px;">
                    <div style="background: #f8f9fa; padding: 25px; border-radius: 12px; border-left: 4px solid #28a745;">
                        <h4 style="color: #28a745; margin-bottom: 20px; font-size: 18px;"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 8px; vertical-align: middle;"><path d="M3 21l18-18"></path><path d="M6 3h3v18h-3"></path><path d="M15 3h3v18h-3"></path></svg> Расчет для новостройки</h4>
                        
                        <div style="margin-bottom: 15px;">
                            <strong>1. Базовая стоимость:</strong><br>
                            ${formatNumber(newBuildPrice)} ₽
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <strong>2. Дополнительные расходы:</strong><br>
                            • Ремонт: ${formatNumber(newBuildRenovation)} ₽<br>
                            • Юридические услуги: ${formatNumber(legalCosts)} ₽<br>
                            ${customParams.newTotal > 0 ? `• Доп. параметры: ${formatNumber(customParams.newTotal)} ₽<br>` : ''}
                            = ${formatNumber(newBuildRenovation + legalCosts + customParams.newTotal)} ₽
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <strong>3. Общая стоимость объекта:</strong><br>
                            ${formatNumber(newBuildPrice)} + ${formatNumber(newBuildRenovation + legalCosts + customParams.newTotal)} = ${formatNumber(newBuildPrice + newBuildRenovation + legalCosts + customParams.newTotal)} ₽
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <strong>4. Первоначальный взнос (${downPayment}%):</strong><br>
                            ${formatNumber(newDownPaymentAmount)} ₽
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <strong>5. Сумма кредита:</strong><br>
                            ${formatNumber(newLoanAmount)} ₽
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <strong>6. Ежемесячный платеж:</strong><br>
                            ${formatNumber(newMonthlyPayment)} ₽/месяц
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <strong>7. Аренда до сдачи (${newBuildDelivery} мес.):</strong><br>
                            ${formatNumber(currentRent)} × ${newBuildDelivery} = ${formatNumber(newWaitingCosts)} ₽
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <strong>8. Прогнозируемая стоимость к сдаче:</strong><br>
                            ${formatNumber(newBuildPrice)} × (1 + ${priceGrowthNew}%)^${(newBuildDelivery/12).toFixed(1)} = ${formatNumber(newFutureValue)} ₽
                        </div>
                        
                        <div style="padding-top: 15px; border-top: 2px solid #28a745; font-weight: bold;">
                            <strong>Итоговые затраты: ${formatNumber(newTotalCost)} ₽</strong>
                        </div>
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 25px; border-radius: 12px; border-left: 4px solid #007bff;">
                        <h4 style="color: #4F2CD9; margin-bottom: 20px; font-size: 18px;"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 8px; vertical-align: middle;"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9,22 9,12 15,12 15,22"></polyline></svg> Расчет для вторички</h4>
                        
                        <div style="margin-bottom: 15px;">
                            <strong>1. Базовая стоимость:</strong><br>
                            ${formatNumber(secondaryPrice)} ₽
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <strong>2. Дополнительные расходы:</strong><br>
                            • Ремонт: ${formatNumber(secondaryRenovation)} ₽<br>
                            • Юридические услуги: ${formatNumber(legalCosts)} ₽<br>
                            ${customParams.secondaryTotal > 0 ? `• Доп. параметры: ${formatNumber(customParams.secondaryTotal)} ₽<br>` : ''}
                            = ${formatNumber(secondaryRenovation + legalCosts + customParams.secondaryTotal)} ₽
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <strong>3. Общая стоимость объекта:</strong><br>
                            ${formatNumber(secondaryPrice)} + ${formatNumber(secondaryRenovation + legalCosts + customParams.secondaryTotal)} = ${formatNumber(secondaryPrice + secondaryRenovation + legalCosts + customParams.secondaryTotal)} ₽
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <strong>4. Первоначальный взнос (${downPayment}%):</strong><br>
                            ${formatNumber(secondaryDownPaymentAmount)} ₽
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <strong>5. Сумма кредита:</strong><br>
                            ${formatNumber(secondaryLoanAmount)} ₽
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <strong>6. Ежемесячный платеж:</strong><br>
                            ${formatNumber(secondaryMonthlyPayment)} ₽/месяц
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <strong>7. Преимущество:</strong><br>
                            Готова к проживанию сразу
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <strong>8. Рыночная динамика:</strong><br>
                            Рост стоимости: ${priceGrowthSecondary}% в год
                        </div>
                        
                        <div style="padding-top: 15px; border-top: 2px solid #007bff; font-weight: bold;">
                            <strong>Итоговые затраты: ${formatNumber(secondaryTotalCost)} ₽</strong>
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 30px; padding: 20px; background: linear-gradient(135deg, #e3f2fd, #f0f7ff); border-radius: 12px; text-align: center;">
                    <h4 style="color: #1976d2; margin-bottom: 15px;"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 8px; vertical-align: middle;"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg> Основные выводы</h4>
                    <p style="margin: 10px 0; color: #333;">
                        <strong>Разница в стоимости:</strong> ${formatNumber(Math.abs(newTotalCost - secondaryTotalCost))} ₽
                        (${newTotalCost < secondaryTotalCost ? 'новостройка дешевле' : 'вторичка дешевле'})
                    </p>
                    <p style="margin: 10px 0; color: #333;">
                        <strong>Разница в ежемесячных платежах:</strong> ${formatNumber(Math.abs(newMonthlyPayment - secondaryMonthlyPayment))} ₽
                    </p>
                    <p style="margin: 10px 0; color: #666; font-size: 14px;">
                        * Расчеты носят информационный характер. Для точного расчета обратитесь к специалистам М2.
                    </p>
                </div>
            `;
        }

        // Performance optimization with requestAnimationFrame
        function performanceOptimizedCalculation() {
            requestAnimationFrame(() => {
                calculateComparison();
            });
        }

        // Debounced calculation function for better performance
        const debouncedCalculateComparison = debounce(performanceOptimizedCalculation, 150);

        // Event listeners with debouncing
        document.getElementById('newBuildPrice').addEventListener('input', debouncedCalculateComparison);
        document.getElementById('secondaryPrice').addEventListener('input', debouncedCalculateComparison);
        document.getElementById('newBuildDelivery').addEventListener('input', debouncedCalculateComparison);
        document.getElementById('newBuildRenovation').addEventListener('input', debouncedCalculateComparison);
        document.getElementById('secondaryRenovation').addEventListener('input', debouncedCalculateComparison);
        document.getElementById('legalCosts').addEventListener('input', debouncedCalculateComparison);
        document.getElementById('currentRent').addEventListener('input', debouncedCalculateComparison);
        document.getElementById('mortgageRate').addEventListener('input', debouncedCalculateComparison);
        document.getElementById('priceGrowthNew').addEventListener('input', debouncedCalculateComparison);
        document.getElementById('priceGrowthSecondary').addEventListener('input', debouncedCalculateComparison);
        document.getElementById('downPayment').addEventListener('input', debouncedCalculateComparison);
        document.getElementById('loanTerm').addEventListener('input', debouncedCalculateComparison);

        // Initial calculation
        calculateComparison();
    </script>
<script src="m2-layout.js"></script>
</body>
</html>