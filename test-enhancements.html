<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç M2 Calculator Enhancements</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8f9fa;
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #007bff;
            text-align: center;
            margin-bottom: 30px;
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .status-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #007bff;
        }

        .status-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: #333;
        }

        .status-value {
            font-size: 14px;
            color: #666;
            word-break: break-all;
        }

        .test-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 30px 0;
        }

        .test-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .test-btn:hover {
            background: #0056b3;
            transform: translateY(-2px);
        }

        .test-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 12px;
            line-height: 1.4;
            max-height: 300px;
            overflow-y: auto;
        }

        .success {
            color: #28a745;
        }

        .error {
            color: #dc3545;
        }

        .warning {
            color: #ffc107;
        }

        .info {
            color: #17a2b8;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ –¢–µ—Å—Ç M2 Calculator Enhancements v1.1</h1>

        <div class="status-grid" id="statusGrid">
            <div class="status-card">
                <div class="status-title">–°–∏—Å—Ç–µ–º–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞</div>
                <div class="status-value" id="systemLoaded">–ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è...</div>
            </div>

            <div class="status-card">
                <div class="status-title">–ó–∞–≥—Ä—É–∂–µ–Ω–æ –º–æ–¥—É–ª–µ–π</div>
                <div class="status-value" id="modulesLoaded">0 / 17</div>
            </div>

            <div class="status-card">
                <div class="status-title">API —Å—Ç–∞—Ç—É—Å</div>
                <div class="status-value" id="apiStatus">–ù–µ –≥–æ—Ç–æ–≤</div>
            </div>

            <div class="status-card">
                <div class="status-title">–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ</div>
                <div class="status-value" id="deviceInfo">–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è...</div>
            </div>
        </div>

        <div class="test-buttons">
            <button class="test-btn" onclick="testAPI()">üîß –¢–µ—Å—Ç API</button>
            <button class="test-btn" onclick="testAI()">ü§ñ –¢–µ—Å—Ç AI</button>
            <button class="test-btn" onclick="testPWA()">üì± –¢–µ—Å—Ç PWA</button>
            <button class="test-btn" onclick="testThemes()">üé® –¢–µ—Å—Ç —Ç–µ–º</button>
            <button class="test-btn" onclick="testAnalytics()">üìä –¢–µ—Å—Ç –∞–Ω–∞–ª–∏—Ç–∏–∫–∏</button>
            <button class="test-btn" onclick="testTemplates()">üìã –¢–µ—Å—Ç —à–∞–±–ª–æ–Ω–æ–≤</button>
            <button class="test-btn" onclick="showDashboard()">üìà –ü–æ–∫–∞–∑–∞—Ç—å –¥–∞—à–±–æ—Ä–¥</button>
            <button class="test-btn" onclick="exportData()">üíæ –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</button>
        </div>

        <div class="log" id="testLog">
            <div class="info">üîÑ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è...</div>
        </div>
    </div>

    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º —Å–∏—Å—Ç–µ–º—É —É–ª—É—á—à–µ–Ω–∏–π -->
    <script src="m2-enhancements-loader.js"></script>

    <script>
        let testLog = [];

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            testLog.push({ timestamp, message, type });

            const logElement = document.getElementById('testLog');
            const logEntry = document.createElement('div');
            logEntry.className = type;
            logEntry.textContent = `[${timestamp}] ${message}`;
            logElement.appendChild(logEntry);

            logElement.scrollTop = logElement.scrollHeight;
        }

        function updateStatus() {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–≥—Ä—É–∑–∫—É —Å–∏—Å—Ç–µ–º—ã
            const systemLoaded = !!window.M2EnhancementsLoader;
            document.getElementById('systemLoaded').textContent = systemLoaded ? '‚úÖ –î–∞' : '‚ùå –ù–µ—Ç';
            document.getElementById('systemLoaded').className = systemLoaded ? 'success' : 'error';

            // –°—á–∏—Ç–∞–µ–º –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏
            const moduleCount = Object.keys(window).filter(key => key.startsWith('M2')).length;
            document.getElementById('modulesLoaded').textContent = `${moduleCount} / 17`;

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º API
            const apiReady = !!window.M2API;
            document.getElementById('apiStatus').textContent = apiReady ? '‚úÖ –ì–æ—Ç–æ–≤' : '‚ùå –ù–µ –≥–æ—Ç–æ–≤';

            // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ
            if (window.M2MobileOptimizer) {
                const deviceInfo = window.M2MobileOptimizer.getDeviceInfo();
                document.getElementById('deviceInfo').textContent =
                    `${deviceInfo.isMobile ? 'üì± –ú–æ–±–∏–ª—å–Ω–æ–µ' : 'üíª –î–µ—Å–∫—Ç–æ–ø'} —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ`;
            }

            log(`–°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª–µ–Ω: ${moduleCount} –º–æ–¥—É–ª–µ–π –∑–∞–≥—Ä—É–∂–µ–Ω–æ`, 'info');
        }

        // –¢–µ—Å—Ç–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        async function testAPI() {
            log('üîß –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ API...', 'info');

            if (!window.M2API) {
                log('‚ùå M2API –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω', 'error');
                return;
            }

            try {
                // –¢–µ—Å—Ç —Ä–∞—Å—á–µ—Ç–∞ –∏–ø–æ—Ç–µ–∫–∏
                const result = await window.M2API.calculate('mortgage', {
                    propertyPrice: 5000000,
                    downPayment: 1000000,
                    interestRate: 8.5,
                    loanTerm: 20
                });

                if (result.success) {
                    log(`‚úÖ API —Ä–∞–±–æ—Ç–∞–µ—Ç: –ü–ª–∞—Ç–µ–∂ = ${result.data.monthlyPayment.toLocaleString()} —Ä—É–±`, 'success');
                } else {
                    log(`‚ùå –û—à–∏–±–∫–∞ API: ${result.error}`, 'error');
                }

                // –¢–µ—Å—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏
                const validation = await window.M2API.validateParameters('mortgage', {
                    propertyPrice: 5000000
                });

                log(`üîç –í–∞–ª–∏–¥–∞—Ü–∏—è: ${validation.valid ? '–ü—Ä–æ—à–ª–∞' : '–ù–µ –ø—Ä–æ—à–ª–∞'}`, validation.valid ? 'success' : 'warning');

            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è API: ${error.message}`, 'error');
            }
        }

        function testAI() {
            log('ü§ñ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ AI –ø–æ–º–æ—â–Ω–∏–∫–∞...', 'info');

            if (!window.M2AI) {
                log('‚ùå M2AI –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω', 'error');
                return;
            }

            try {
                window.M2AI.toggle();
                log('‚úÖ AI –ø–æ–º–æ—â–Ω–∏–∫ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω', 'success');

                setTimeout(() => {
                    window.M2AI.askQuestion('–ö–∞–∫–æ–π –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω—ã–π –≤–∑–Ω–æ—Å?');
                    log('‚úÖ –¢–µ—Å—Ç–æ–≤—ã–π –≤–æ–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω AI', 'success');
                }, 1000);

            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è AI: ${error.message}`, 'error');
            }
        }

        function testPWA() {
            log('üì± –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ PWA...', 'info');

            if (!window.M2PWA) {
                log('‚ùå M2PWA –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω', 'error');
                return;
            }

            try {
                const status = window.M2PWA.getPWAStatus();
                log(`üì± PWA —Å—Ç–∞—Ç—É—Å: –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ=${status.isInstalled}, –î–æ—Å—Ç—É–ø–Ω–æ=${status.isInstallable}`, 'info');
                log(`üîå –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ: ${status.isOnline ? '–û–Ω–ª–∞–π–Ω' : '–û—Ñ–ª–∞–π–Ω'}`, status.isOnline ? 'success' : 'warning');
                log(`‚öôÔ∏è Service Worker: ${status.serviceWorkerRegistered ? '–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω' : '–ù–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω'}`, 'info');

            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è PWA: ${error.message}`, 'error');
            }
        }

        function testThemes() {
            log('üé® –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–º...', 'info');

            if (!window.M2DarkTheme) {
                log('‚ùå M2DarkTheme –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω', 'error');
                return;
            }

            try {
                const currentTheme = window.M2DarkTheme.getCurrentTheme();
                log(`üé® –¢–µ–∫—É—â–∞—è —Ç–µ–º–∞: ${currentTheme}`, 'info');

                // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º —Ç–µ–º—É –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏
                window.M2DarkTheme.toggleTheme();
                log('‚úÖ –¢–µ–º–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∞', 'success');

            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–µ–º: ${error.message}`, 'error');
            }
        }

        function testAnalytics() {
            log('üìä –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏...', 'info');

            if (!window.M2Analytics) {
                log('‚ùå M2Analytics –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω', 'error');
                return;
            }

            try {
                const metrics = window.M2Analytics.getMetrics();
                log(`üìä –°–µ—Å—Å–∏—è: ${Math.round(metrics.sessionDuration / 1000)}—Å, –°–æ–±—ã—Ç–∏—è: ${window.M2Analytics.events.length}`, 'info');
                log(`üßÆ –†–∞—Å—á–µ—Ç—ã: ${metrics.calculations}, –í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è: ${metrics.interactions}`, 'info');
                log(`üéØ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏: ${metrics.featuresUsed.join(', ')}`, 'success');

            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏: ${error.message}`, 'error');
            }
        }

        function testTemplates() {
            log('üìã –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–æ–≤...', 'info');

            if (!window.M2Templates) {
                log('‚ùå M2Templates –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω', 'error');
                return;
            }

            try {
                const templates = window.M2Templates.getTemplates();
                log(`üìã –î–æ—Å—Ç—É–ø–Ω–æ —à–∞–±–ª–æ–Ω–æ–≤: ${templates.length}`, 'info');

                if (templates.length > 0) {
                    log(`üìã –ü—Ä–∏–º–µ—Ä—ã: ${templates.slice(0, 3).map(t => t.name).join(', ')}`, 'success');
                }

            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —à–∞–±–ª–æ–Ω–æ–≤: ${error.message}`, 'error');
            }
        }

        function showDashboard() {
            log('üìà –û—Ç–∫—Ä—ã—Ç–∏–µ –¥–∞—à–±–æ—Ä–¥–∞ –º–µ—Ç—Ä–∏–∫...', 'info');

            if (!window.M2MetricsDashboard) {
                log('‚ùå M2MetricsDashboard –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω', 'error');
                log('üí° –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –Ω–∞–∂–∞—Ç—å Ctrl+Alt+D', 'info');
                return;
            }

            try {
                window.M2MetricsDashboard.show();
                log('‚úÖ –î–∞—à–±–æ—Ä–¥ –º–µ—Ç—Ä–∏–∫ –æ—Ç–∫—Ä—ã—Ç', 'success');

            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è –¥–∞—à–±–æ—Ä–¥–∞: ${error.message}`, 'error');
            }
        }

        async function exportData() {
            log('üíæ –≠–∫—Å–ø–æ—Ä—Ç —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö...', 'info');

            try {
                const exportData = {
                    timestamp: new Date().toISOString(),
                    testResults: testLog,
                    systemStatus: {
                        modulesLoaded: Object.keys(window).filter(key => key.startsWith('M2')),
                        analytics: window.M2Analytics?.getMetrics(),
                        device: window.M2MobileOptimizer?.getDeviceInfo(),
                        pwa: window.M2PWA?.getPWAStatus(),
                        monitoring: window.M2Monitoring?.getMonitoringStatus()
                    }
                };

                const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `m2-test-results-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);

                log('‚úÖ –î–∞–Ω–Ω—ã–µ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã', 'success');

            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞: ${error.message}`, 'error');
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', () => {
            log('üöÄ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞, –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å–∏—Å—Ç–µ–º—É...', 'info');

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∫–∞–∂–¥—ã–µ 2 —Å–µ–∫—É–Ω–¥—ã
            setInterval(updateStatus, 2000);

            // –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
            setTimeout(updateStatus, 1000);

            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ç–µ—Å—Ç—ã —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
            setTimeout(() => {
                log('üîÑ –ó–∞–ø—É—Å–∫ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ç–µ—Å—Ç–æ–≤...', 'info');
                testAPI();
                setTimeout(() => testAnalytics(), 1000);
                setTimeout(() => testTemplates(), 2000);
            }, 5000);
        });

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥—É–ª–µ–π
        document.addEventListener('moduleLoaded', (event) => {
            log(`üì¶ –ú–æ–¥—É–ª—å –∑–∞–≥—Ä—É–∂–µ–Ω: ${event.detail.name}`, 'success');
            updateStatus();
        });

        // –ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏
        document.addEventListener('keydown', (event) => {
            if (event.ctrlKey && event.altKey) {
                switch (event.key) {
                    case 't':
                        event.preventDefault();
                        testAPI();
                        break;
                    case 'a':
                        event.preventDefault();
                        testAI();
                        break;
                    case 'p':
                        event.preventDefault();
                        testPWA();
                        break;
                }
            }
        });

        log('üéØ –¢–µ—Å—Ç–æ–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ', 'success');
        log('‚å®Ô∏è –ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏: Ctrl+Alt+T (API), Ctrl+Alt+A (AI), Ctrl+Alt+P (PWA)', 'info');
    </script>
</body>
</html>