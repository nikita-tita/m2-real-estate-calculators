<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Калькулятор досрочного погашения - М2</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.5;
            color: #333;
            background-color: #f8f9fa;
            font-size: 14px;
        }

        .header {
            background: white;
            border-bottom: 1px solid #e9ecef;
            padding: 12px 0;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 16px;
        }

        .logo {
            font-size: 32px;
            font-weight: 700;
            color: #007bff;
            text-decoration: none;
        }

        .back-link {
            color: #007bff;
            text-decoration: none;
            font-weight: 500;
            font-size: 16px;
        }

        .back-link:hover {
            text-decoration: underline;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 24px 16px;
        }

        .page-header {
            background: white;
            border-radius: 8px;
            padding: 32px;
            margin-bottom: 24px;
            text-align: center;
            border: 1px solid #e6e6e6;
        }

        .page-title {
            font-size: 32px;
            font-weight: 600;
            color: #333;
            margin-bottom: 16px;
        }

        .page-subtitle {
            font-size: 18px;
            color: #666;
            max-width: 600px;
            margin: 0 auto;
        }

        .calculator-layout {
            display: grid;
            grid-template-columns: 400px 1fr;
            gap: 24px;
            margin-bottom: 24px;
        }

        .calculator-form, .results-section {
            background: white;
            border-radius: 8px;
            padding: 32px;
            border: 1px solid #e6e6e6;
        }

        .form-section {
            margin-bottom: 32px;
        }

        .section-title {
            font-size: 20px;
            font-weight: 600;
            color: #333;
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e6e6e6;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-weight: 500;
            color: #555;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #e6e6e6;
            border-radius: 6px;
            font-size: 16px;
            transition: border-color 0.2s;
            background: white;
        }

        .form-input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
        }

        .form-select {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #e6e6e6;
            border-radius: 6px;
            font-size: 16px;
            background: white;
            cursor: pointer;
        }

        .form-select:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
        }

        .input-suffix {
            position: relative;
        }

        .input-suffix::after {
            content: attr(data-suffix);
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: #666;
            pointer-events: none;
            font-size: 14px;
        }

        .calculate-btn {
            width: 100%;
            padding: 16px 24px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .calculate-btn:hover {
            background: #0056b3;
        }

        .result-highlight {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            padding: 24px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 24px;
        }

        .result-main {
            font-size: 36px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .result-label {
            font-size: 16px;
            opacity: 0.9;
        }

        .results-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 24px;
        }

        .result-item {
            padding: 16px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 4px solid #007bff;
        }

        .result-value {
            font-size: 20px;
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }

        .result-desc {
            font-size: 14px;
            color: #666;
        }

        .chart-container {
            height: 400px;
            margin: 24px 0;
        }

        .comparison-section {
            background: white;
            border-radius: 8px;
            padding: 32px;
            border: 1px solid #e6e6e6;
            margin-bottom: 24px;
        }

        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 16px;
        }

        .comparison-table th,
        .comparison-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e6e6e6;
            font-size: 14px;
        }

        .comparison-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #555;
        }

        .comparison-table tbody tr:hover {
            background: #f8f9fa;
        }

        .strategy-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .tab-btn {
            padding: 12px 20px;
            background: white;
            border: 1px solid #e6e6e6;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
            font-weight: 500;
        }

        .tab-btn.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        .tab-btn:hover:not(.active) {
            border-color: #007bff;
            color: #007bff;
        }

        .export-buttons {
            display: flex;
            gap: 12px;
            margin: 24px 0;
            flex-wrap: wrap;
        }

        .export-btn {
            padding: 12px 20px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background 0.2s;
        }

        .export-btn:hover {
            background: #218838;
        }

        .savings-highlight {
            background: linear-gradient(135deg, #28a745, #1e7e34);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            margin: 16px 0;
        }

        .savings-amount {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .info-tooltip {
            position: relative;
            display: inline-block;
            margin-left: 4px;
            color: #007bff;
            cursor: help;
            font-size: 14px;
        }

        .info-tooltip::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s;
            z-index: 1000;
        }

        .info-tooltip:hover::after {
            opacity: 1;
            visibility: visible;
        }

        @media (max-width: 768px) {
            .calculator-layout {
                grid-template-columns: 1fr;
            }

            .results-grid {
                grid-template-columns: 1fr;
            }

            .page-title {
                font-size: 24px;
            }

            .result-main {
                font-size: 28px;
            }

            .strategy-tabs {
                flex-direction: column;
            }

            .export-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <a href="m2-hub.html" class="logo">М2</a>
            <a href="m2-hub.html" class="back-link">← К выбору расчётов</a>
        </div>
    </header>

    <div class="container">
        <div class="page-header">
            <h1 class="page-title">Калькулятор досрочного погашения</h1>
            <p class="page-subtitle">Рассчитайте выгоду от досрочного погашения ипотеки и выберите оптимальную стратегию экономии</p>
        </div>

        <div class="calculator-layout">
            <div class="calculator-form">
                <form id="prepaymentForm">
                    <div class="form-section">
                        <h3 class="section-title">Текущие условия ипотеки</h3>
                        
                        <div class="form-group">
                            <label class="form-label">
                                Остаток долга по ипотеке
                                <span class="info-tooltip" data-tooltip="Текущая задолженность по кредиту">ℹ</span>
                            </label>
                            <div class="input-suffix" data-suffix="₽">
                                <input type="number" id="remainingDebt" class="form-input" value="3000000" min="1000" step="10000" required>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Процентная ставка</label>
                            <div class="input-suffix" data-suffix="%">
                                <input type="number" id="interestRate" class="form-input" value="9.5" min="1" max="30" step="0.1" required>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Остаток срока кредита</label>
                            <select id="remainingTerm" class="form-select" required>
                                <option value="5">5 лет</option>
                                <option value="10">10 лет</option>
                                <option value="15" selected>15 лет</option>
                                <option value="20">20 лет</option>
                                <option value="25">25 лет</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Текущий ежемесячный платёж</label>
                            <div class="input-suffix" data-suffix="₽">
                                <input type="number" id="currentPayment" class="form-input" value="35000" min="1000" step="1000" required>
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3 class="section-title">Параметры досрочного погашения</h3>
                        
                        <div class="form-group">
                            <label class="form-label">Стратегия досрочного погашения</label>
                            <select id="prepaymentStrategy" class="form-select">
                                <option value="reduce_term">Сокращение срока кредита</option>
                                <option value="reduce_payment" selected>Уменьшение размера платежа</option>
                                <option value="mixed">Смешанная стратегия</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                Сумма досрочного платежа
                                <span class="info-tooltip" data-tooltip="Единоразовая сумма для досрочного погашения">ℹ</span>
                            </label>
                            <div class="input-suffix" data-suffix="₽">
                                <input type="number" id="prepaymentAmount" class="form-input" value="500000" min="10000" step="10000">
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                Регулярные доплаты
                                <span class="info-tooltip" data-tooltip="Дополнительная сумма к обычному платежу каждый месяц">ℹ</span>
                            </label>
                            <div class="input-suffix" data-suffix="₽/мес">
                                <input type="number" id="monthlyExtra" class="form-input" value="10000" min="0" step="1000">
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Когда планируете досрочное погашение</label>
                            <select id="prepaymentTiming" class="form-select">
                                <option value="0" selected>Сразу</option>
                                <option value="6">Через 6 месяцев</option>
                                <option value="12">Через 1 год</option>
                                <option value="24">Через 2 года</option>
                                <option value="36">Через 3 года</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3 class="section-title">Альтернативные вложения</h3>
                        
                        <div class="form-group">
                            <label class="form-label">
                                Доходность альтернативных вложений
                                <span class="info-tooltip" data-tooltip="Например, депозит, облигации, инвестиции в акции">ℹ</span>
                            </label>
                            <div class="input-suffix" data-suffix="% годовых">
                                <input type="number" id="alternativeYield" class="form-input" value="7.5" min="0" max="30" step="0.5">
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Налог на доходы от вложений</label>
                            <div class="input-suffix" data-suffix="%">
                                <input type="number" id="investmentTax" class="form-input" value="13" min="0" max="50" step="1">
                            </div>
                        </div>
                    </div>

                    <button type="button" class="calculate-btn" onclick="calculatePrepayment()">
                        Рассчитать досрочное погашение
                    </button>
                </form>
            </div>

            <div class="results-section" id="resultsSection">
                <div id="resultsContent">
                    <div style="text-align: center; color: #666; padding: 40px 20px;">
                        <p>Заполните форму слева и нажмите "Рассчитать досрочное погашение" для получения подробного анализа</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="strategy-tabs" id="strategyTabs" style="display: none;">
            <button class="tab-btn active" onclick="switchStrategy('reduce_term')">Сокращение срока</button>
            <button class="tab-btn" onclick="switchStrategy('reduce_payment')">Уменьшение платежа</button>
            <button class="tab-btn" onclick="switchStrategy('mixed')">Смешанная стратегия</button>
        </div>

        <div class="comparison-section" id="comparisonSection" style="display: none;">
            <h3 class="section-title">Сравнение стратегий</h3>
            <div id="comparisonContent"></div>
        </div>

        <div class="comparison-section" id="chartSection" style="display: none;">
            <h3 class="section-title">График погашения</h3>
            <div class="chart-container">
                <canvas id="prepaymentChart"></canvas>
            </div>
        </div>

        <div class="comparison-section" id="alternativeSection" style="display: none;">
            <h3 class="section-title">Анализ альтернативных вложений</h3>
            <div id="alternativeContent"></div>
        </div>
    </div>

    <script>
        let prepaymentChart;
        let calculationData = {};

        function calculatePrepayment() {
            const params = getInputValues();
            
            if (!validateInputs(params)) {
                alert('Пожалуйста, введите корректные значения');
                return;
            }

            calculationData = {
                withoutPrepayment: calculateWithoutPrepayment(params),
                reduceTerm: calculateReduceTerm(params),
                reducePayment: calculateReducePayment(params),
                mixed: calculateMixed(params),
                alternative: calculateAlternative(params)
            };

            displayResults();
            showSections();
        }

        function getInputValues() {
            return {
                remainingDebt: parseFloat(document.getElementById('remainingDebt').value),
                interestRate: parseFloat(document.getElementById('interestRate').value) / 100,
                remainingTerm: parseInt(document.getElementById('remainingTerm').value),
                currentPayment: parseFloat(document.getElementById('currentPayment').value),
                prepaymentAmount: parseFloat(document.getElementById('prepaymentAmount').value) || 0,
                monthlyExtra: parseFloat(document.getElementById('monthlyExtra').value) || 0,
                prepaymentTiming: parseInt(document.getElementById('prepaymentTiming').value),
                alternativeYield: parseFloat(document.getElementById('alternativeYield').value) / 100,
                investmentTax: parseFloat(document.getElementById('investmentTax').value) / 100
            };
        }

        function validateInputs(params) {
            return params.remainingDebt > 0 && 
                   params.interestRate >= 0 && 
                   params.remainingTerm > 0 && 
                   params.currentPayment > 0;
        }

        function calculateWithoutPrepayment(params) {
            const monthlyRate = params.interestRate / 12;
            const totalMonths = params.remainingTerm * 12;
            
            const monthlyPayment = params.remainingDebt * 
                (monthlyRate * Math.pow(1 + monthlyRate, totalMonths)) / 
                (Math.pow(1 + monthlyRate, totalMonths) - 1);
                
            const totalPayment = monthlyPayment * totalMonths;
            const totalInterest = totalPayment - params.remainingDebt;
            
            return {
                monthlyPayment,
                totalPayment,
                totalInterest,
                termMonths: totalMonths,
                termYears: params.remainingTerm
            };
        }

        function calculateReduceTerm(params) {
            return calculatePrepaymentScenario(params, 'reduce_term');
        }

        function calculateReducePayment(params) {
            return calculatePrepaymentScenario(params, 'reduce_payment');
        }

        function calculateMixed(params) {
            return calculatePrepaymentScenario(params, 'mixed');
        }

        function calculatePrepaymentScenario(params, strategy) {
            let balance = params.remainingDebt;
            let totalPayment = 0;
            let month = 0;
            const monthlyRate = params.interestRate / 12;
            let currentMonthlyPayment = params.currentPayment;
            const schedule = [];

            // Досрочный платёж через указанное время
            while (balance > 0 && month < params.remainingTerm * 12) {
                month++;
                
                const interestPayment = balance * monthlyRate;
                let principalPayment = currentMonthlyPayment - interestPayment;
                
                // Добавляем регулярные доплаты
                if (params.monthlyExtra > 0) {
                    principalPayment += params.monthlyExtra;
                }
                
                // Добавляем единоразовый досрочный платёж
                if (month === params.prepaymentTiming + 1 && params.prepaymentAmount > 0) {
                    principalPayment += params.prepaymentAmount;
                }
                
                if (principalPayment > balance) {
                    principalPayment = balance;
                }
                
                const payment = interestPayment + principalPayment;
                balance -= principalPayment;
                totalPayment += payment;
                
                if (month <= 12 || month % 12 === 0) {
                    schedule.push({
                        month,
                        payment,
                        principal: principalPayment,
                        interest: interestPayment,
                        balance: Math.max(balance, 0)
                    });
                }
                
                // Пересчёт платежа для разных стратегий
                if (month === params.prepaymentTiming + 1 && params.prepaymentAmount > 0) {
                    if (strategy === 'reduce_payment' && balance > 0) {
                        const remainingMonths = params.remainingTerm * 12 - month;
                        currentMonthlyPayment = balance * 
                            (monthlyRate * Math.pow(1 + monthlyRate, remainingMonths)) / 
                            (Math.pow(1 + monthlyRate, remainingMonths) - 1);
                    }
                }
                
                if (balance <= 0) break;
            }
            
            const totalInterest = totalPayment - params.remainingDebt;
            const savedInterest = calculationData.withoutPrepayment ? 
                calculationData.withoutPrepayment.totalInterest - totalInterest : 0;
            
            return {
                monthlyPayment: currentMonthlyPayment,
                totalPayment,
                totalInterest,
                savedInterest,
                termMonths: month,
                termYears: Math.ceil(month / 12),
                schedule
            };
        }

        function calculateAlternative(params) {
            const investmentAmount = params.prepaymentAmount;
            const monthlyInvestment = params.monthlyExtra;
            const netYield = params.alternativeYield * (1 - params.investmentTax);
            
            // Рассчитываем доход от альтернативных вложений
            const years = params.remainingTerm;
            let totalInvestment = investmentAmount;
            let futureValue = investmentAmount;
            
            // Компаундирование основной суммы
            futureValue *= Math.pow(1 + netYield, years);
            
            // Добавляем ежемесячные вложения
            if (monthlyInvestment > 0) {
                const monthlyYield = netYield / 12;
                const months = years * 12;
                const monthlyFV = monthlyInvestment * 
                    ((Math.pow(1 + monthlyYield, months) - 1) / monthlyYield);
                futureValue += monthlyFV;
                totalInvestment += monthlyInvestment * months;
            }
            
            const investmentProfit = futureValue - totalInvestment;
            
            return {
                totalInvestment,
                futureValue,
                investmentProfit,
                netYield: netYield * 100
            };
        }

        function displayResults() {
            const base = calculationData.withoutPrepayment;
            const optimal = findOptimalStrategy();
            
            const resultsHTML = `
                <div class="result-highlight">
                    <div class="result-main">${formatCurrency(optimal.savedInterest)}</div>
                    <div class="result-label">Экономия на процентах</div>
                </div>

                <div class="results-grid">
                    <div class="result-item">
                        <div class="result-value">${formatCurrency(optimal.monthlyPayment)}</div>
                        <div class="result-desc">Новый ежемесячный платёж</div>
                    </div>
                    <div class="result-item">
                        <div class="result-value">${optimal.termYears} лет</div>
                        <div class="result-desc">Новый срок кредита</div>
                    </div>
                    <div class="result-item">
                        <div class="result-value">${formatCurrency(base.totalInterest - optimal.totalInterest)}</div>
                        <div class="result-desc">Экономия на переплате</div>
                    </div>
                    <div class="result-item">
                        <div class="result-value">${((base.termYears - optimal.termYears) * 12).toFixed(0)} мес</div>
                        <div class="result-desc">Сокращение срока</div>
                    </div>
                </div>

                <div class="savings-highlight">
                    <div class="savings-amount">${formatCurrency(optimal.savedInterest)}</div>
                    <div>Общая выгода от досрочного погашения</div>
                </div>

                <div class="export-buttons">
                    <button class="export-btn" onclick="exportToExcel()">📊 Экспорт в Excel</button>
                    <button class="export-btn" onclick="exportToPDF()">📄 Экспорт в PDF</button>
                    <button class="export-btn" onclick="saveCalculation()">💾 Сохранить расчёт</button>
                </div>

                <div class="chart-container">
                    <canvas id="savingsChart"></canvas>
                </div>
            `;

            document.getElementById('resultsContent').innerHTML = resultsHTML;
            createSavingsChart();
        }

        function findOptimalStrategy() {
            const strategies = [
                calculationData.reduceTerm,
                calculationData.reducePayment,
                calculationData.mixed
            ];
            
            return strategies.reduce((best, current) => 
                current.savedInterest > best.savedInterest ? current : best
            );
        }

        function displayComparison() {
            const strategies = [
                { name: 'Без досрочного погашения', data: calculationData.withoutPrepayment },
                { name: 'Сокращение срока', data: calculationData.reduceTerm },
                { name: 'Уменьшение платежа', data: calculationData.reducePayment },
                { name: 'Смешанная стратегия', data: calculationData.mixed }
            ];

            let tableHTML = `
                <table class="comparison-table">
                    <thead>
                        <tr>
                            <th>Стратегия</th>
                            <th>Ежемесячный платёж</th>
                            <th>Срок кредита</th>
                            <th>Общая переплата</th>
                            <th>Экономия</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            strategies.forEach(strategy => {
                const savings = strategy.data.savedInterest || 0;
                tableHTML += `
                    <tr>
                        <td>${strategy.name}</td>
                        <td>${formatCurrency(strategy.data.monthlyPayment)}</td>
                        <td>${strategy.data.termYears} лет</td>
                        <td>${formatCurrency(strategy.data.totalInterest)}</td>
                        <td style="color: ${savings > 0 ? '#28a745' : '#333'}">${formatCurrency(savings)}</td>
                    </tr>
                `;
            });

            tableHTML += '</tbody></table>';
            
            // Добавляем анализ альтернативных вложений
            const alt = calculationData.alternative;
            tableHTML += `
                <h4 style="margin-top: 32px; margin-bottom: 16px;">Альтернативные вложения</h4>
                <div class="results-grid">
                    <div class="result-item">
                        <div class="result-value">${formatCurrency(alt.futureValue)}</div>
                        <div class="result-desc">Стоимость вложений через ${getInputValues().remainingTerm} лет</div>
                    </div>
                    <div class="result-item">
                        <div class="result-value">${formatCurrency(alt.investmentProfit)}</div>
                        <div class="result-desc">Прибыль от альтернативных вложений</div>
                    </div>
                </div>
                
                <div style="margin-top: 16px; padding: 16px; background: #fff3cd; border-radius: 6px; border-left: 4px solid #ffc107;">
                    <strong>Рекомендация:</strong> ${alt.investmentProfit > findOptimalStrategy().savedInterest ? 
                        'Выгоднее инвестировать свободные средства, чем досрочно погашать ипотеку' : 
                        'Досрочное погашение ипотеки выгоднее альтернативных вложений'}
                </div>
            `;

            document.getElementById('comparisonContent').innerHTML = tableHTML;
        }

        function createSavingsChart() {
            const ctx = document.getElementById('savingsChart').getContext('2d');
            
            if (window.savingsChartInstance) {
                window.savingsChartInstance.destroy();
            }

            const base = calculationData.withoutPrepayment;
            const optimal = findOptimalStrategy();
            
            window.savingsChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Сэкономлено', 'К доплате'],
                    datasets: [{
                        data: [optimal.savedInterest, optimal.totalInterest],
                        backgroundColor: ['#28a745', '#007bff'],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.label + ': ' + formatCurrency(context.raw);
                                }
                            }
                        }
                    }
                }
            });
        }

        function createPrepaymentChart() {
            const ctx = document.getElementById('prepaymentChart').getContext('2d');
            
            if (prepaymentChart) {
                prepaymentChart.destroy();
            }

            const base = calculationData.withoutPrepayment.schedule || [];
            const optimal = findOptimalStrategy().schedule || [];
            
            prepaymentChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: optimal.map(d => `Месяц ${d.month}`),
                    datasets: [
                        {
                            label: 'Остаток долга с досрочным погашением',
                            data: optimal.map(d => d.balance),
                            borderColor: '#28a745',
                            backgroundColor: 'transparent',
                            tension: 0.4
                        },
                        {
                            label: 'Остаток долга без досрочного погашения',
                            data: base.map(d => d.balance),
                            borderColor: '#dc3545',
                            backgroundColor: 'transparent',
                            borderDash: [5, 5],
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Динамика погашения задолженности'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        }
                    }
                }
            });
        }

        function showSections() {
            document.getElementById('strategyTabs').style.display = 'flex';
            document.getElementById('comparisonSection').style.display = 'block';
            document.getElementById('chartSection').style.display = 'block';
            document.getElementById('alternativeSection').style.display = 'block';
            
            displayComparison();
            createPrepaymentChart();
        }

        function switchStrategy(strategy) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // Можно добавить переключение между различными стратегиями
            displayComparison();
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('ru-RU', {
                style: 'currency',
                currency: 'RUB',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        }

        function exportToExcel() {
            alert('Функция экспорта в Excel будет добавлена в следующей версии');
        }

        function exportToPDF() {
            alert('Функция экспорта в PDF будет добавлена в следующей версии');
        }

        function saveCalculation() {
            const data = {
                inputs: getInputValues(),
                results: calculationData,
                timestamp: new Date().toISOString()
            };
            
            localStorage.setItem('prepaymentCalculation', JSON.stringify(data));
            alert('Расчёт сохранён в браузере');
        }

        // Автоматический расчёт при загрузке
        document.addEventListener('DOMContentLoaded', function() {
            calculatePrepayment();
        });
    </script>
</body>
</html>