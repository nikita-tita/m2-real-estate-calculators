<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –¥–æ—Å—Ä–æ—á–Ω–æ–≥–æ –ø–æ–≥–∞—à–µ–Ω–∏—è - –ú2</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.5;
            color: #333;
            background-color: #f8f9fa;
            font-size: 14px;
        }

        .header {
            background: white;
            border-bottom: 1px solid #e9ecef;
            padding: 12px 0;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 16px;
        }

        .logo {
            font-size: 32px;
            font-weight: 700;
            color: #007bff;
            text-decoration: none;
        }

        .back-link {
            color: #007bff;
            text-decoration: none;
            font-weight: 500;
            font-size: 16px;
        }

        .back-link:hover {
            text-decoration: underline;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 24px 16px;
        }

        .page-header {
            background: white;
            border-radius: 8px;
            padding: 32px;
            margin-bottom: 24px;
            text-align: center;
            border: 1px solid #e6e6e6;
        }

        .page-title {
            font-size: 32px;
            font-weight: 600;
            color: #333;
            margin-bottom: 16px;
        }

        .page-subtitle {
            font-size: 18px;
            color: #666;
            max-width: 600px;
            margin: 0 auto;
        }

        .calculator-layout {
            display: grid;
            grid-template-columns: 400px 1fr;
            gap: 24px;
            margin-bottom: 24px;
        }

        .calculator-form, .results-section {
            background: white;
            border-radius: 8px;
            padding: 32px;
            border: 1px solid #e6e6e6;
        }

        .form-section {
            margin-bottom: 32px;
        }

        .section-title {
            font-size: 20px;
            font-weight: 600;
            color: #333;
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e6e6e6;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-weight: 500;
            color: #555;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #e6e6e6;
            border-radius: 6px;
            font-size: 16px;
            transition: border-color 0.2s;
            background: white;
        }

        .form-input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
        }

        .form-select {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #e6e6e6;
            border-radius: 6px;
            font-size: 16px;
            background: white;
            cursor: pointer;
        }

        .form-select:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
        }

        .input-suffix {
            position: relative;
        }

        .input-suffix::after {
            content: attr(data-suffix);
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: #666;
            pointer-events: none;
            font-size: 14px;
        }

        .calculate-btn {
            width: 100%;
            padding: 16px 24px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .calculate-btn:hover {
            background: #0056b3;
        }

        .result-highlight {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            padding: 24px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 24px;
        }

        .result-main {
            font-size: 36px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .result-label {
            font-size: 16px;
            opacity: 0.9;
        }

        .results-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 24px;
        }

        .result-item {
            padding: 16px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 4px solid #007bff;
        }

        .result-value {
            font-size: 20px;
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }

        .result-desc {
            font-size: 14px;
            color: #666;
        }

        .chart-container {
            height: 400px;
            margin: 24px 0;
        }

        .comparison-section {
            background: white;
            border-radius: 8px;
            padding: 32px;
            border: 1px solid #e6e6e6;
            margin-bottom: 24px;
        }

        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 16px;
        }

        .comparison-table th,
        .comparison-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e6e6e6;
            font-size: 14px;
        }

        .comparison-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #555;
        }

        .comparison-table tbody tr:hover {
            background: #f8f9fa;
        }

        .strategy-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .tab-btn {
            padding: 12px 20px;
            background: white;
            border: 1px solid #e6e6e6;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
            font-weight: 500;
        }

        .tab-btn.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        .tab-btn:hover:not(.active) {
            border-color: #007bff;
            color: #007bff;
        }

        .export-buttons {
            display: flex;
            gap: 12px;
            margin: 24px 0;
            flex-wrap: wrap;
        }

        .export-btn {
            padding: 12px 20px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background 0.2s;
        }

        .export-btn:hover {
            background: #218838;
        }

        .savings-highlight {
            background: linear-gradient(135deg, #28a745, #1e7e34);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            margin: 16px 0;
        }

        .savings-amount {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .info-tooltip {
            position: relative;
            display: inline-block;
            margin-left: 4px;
            color: #007bff;
            cursor: help;
            font-size: 14px;
        }

        .info-tooltip::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s;
            z-index: 1000;
        }

        .info-tooltip:hover::after {
            opacity: 1;
            visibility: visible;
        }

        @media (max-width: 768px) {
            .calculator-layout {
                grid-template-columns: 1fr;
            }

            .results-grid {
                grid-template-columns: 1fr;
            }

            .page-title {
                font-size: 24px;
            }

            .result-main {
                font-size: 28px;
            }

            .strategy-tabs {
                flex-direction: column;
            }

            .export-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <a href="m2-hub.html" class="logo">–ú2</a>
            <a href="m2-hub.html" class="back-link">‚Üê –ö –≤—ã–±–æ—Ä—É —Ä–∞—Å—á—ë—Ç–æ–≤</a>
        </div>
    </header>

    <div class="container">
        <div class="page-header">
            <h1 class="page-title">–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –¥–æ—Å—Ä–æ—á–Ω–æ–≥–æ –ø–æ–≥–∞—à–µ–Ω–∏—è</h1>
            <p class="page-subtitle">–†–∞—Å—Å—á–∏—Ç–∞–π—Ç–µ –≤—ã–≥–æ–¥—É –æ—Ç –¥–æ—Å—Ä–æ—á–Ω–æ–≥–æ –ø–æ–≥–∞—à–µ–Ω–∏—è –∏–ø–æ—Ç–µ–∫–∏ –∏ –≤—ã–±–µ—Ä–∏—Ç–µ –æ–ø—Ç–∏–º–∞–ª—å–Ω—É—é —Å—Ç—Ä–∞—Ç–µ–≥–∏—é —ç–∫–æ–Ω–æ–º–∏–∏</p>
        </div>

        <div class="calculator-layout">
            <div class="calculator-form">
                <form id="prepaymentForm">
                    <div class="form-section">
                        <h3 class="section-title">–¢–µ–∫—É—â–∏–µ —É—Å–ª–æ–≤–∏—è –∏–ø–æ—Ç–µ–∫–∏</h3>
                        
                        <div class="form-group">
                            <label class="form-label">
                                –û—Å—Ç–∞—Ç–æ–∫ –¥–æ–ª–≥–∞ –ø–æ –∏–ø–æ—Ç–µ–∫–µ
                                <span class="info-tooltip" data-tooltip="–¢–µ–∫—É—â–∞—è –∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç—å –ø–æ –∫—Ä–µ–¥–∏—Ç—É">‚Ñπ</span>
                            </label>
                            <div class="input-suffix" data-suffix="‚ÇΩ">
                                <input type="number" id="remainingDebt" class="form-input" value="3000000" min="1000" step="10000" required>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">–ü—Ä–æ—Ü–µ–Ω—Ç–Ω–∞—è —Å—Ç–∞–≤–∫–∞</label>
                            <div class="input-suffix" data-suffix="%">
                                <input type="number" id="interestRate" class="form-input" value="9.5" min="1" max="30" step="0.1" required>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">–û—Å—Ç–∞—Ç–æ–∫ —Å—Ä–æ–∫–∞ –∫—Ä–µ–¥–∏—Ç–∞</label>
                            <select id="remainingTerm" class="form-select" required>
                                <option value="5">5 –ª–µ—Ç</option>
                                <option value="10">10 –ª–µ—Ç</option>
                                <option value="15" selected>15 –ª–µ—Ç</option>
                                <option value="20">20 –ª–µ—Ç</option>
                                <option value="25">25 –ª–µ—Ç</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">–¢–µ–∫—É—â–∏–π –µ–∂–µ–º–µ—Å—è—á–Ω—ã–π –ø–ª–∞—Ç—ë–∂</label>
                            <div class="input-suffix" data-suffix="‚ÇΩ">
                                <input type="number" id="currentPayment" class="form-input" value="35000" min="1000" step="1000" required>
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3 class="section-title">–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–æ—Å—Ä–æ—á–Ω–æ–≥–æ –ø–æ–≥–∞—à–µ–Ω–∏—è</h3>
                        
                        <div class="form-group">
                            <label class="form-label">–°—Ç—Ä–∞—Ç–µ–≥–∏—è –¥–æ—Å—Ä–æ—á–Ω–æ–≥–æ –ø–æ–≥–∞—à–µ–Ω–∏—è</label>
                            <select id="prepaymentStrategy" class="form-select">
                                <option value="reduce_term">–°–æ–∫—Ä–∞—â–µ–Ω–∏–µ —Å—Ä–æ–∫–∞ –∫—Ä–µ–¥–∏—Ç–∞</option>
                                <option value="reduce_payment" selected>–£–º–µ–Ω—å—à–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ –ø–ª–∞—Ç–µ–∂–∞</option>
                                <option value="mixed">–°–º–µ—à–∞–Ω–Ω–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                –°—É–º–º–∞ –¥–æ—Å—Ä–æ—á–Ω–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞
                                <span class="info-tooltip" data-tooltip="–ï–¥–∏–Ω–æ—Ä–∞–∑–æ–≤–∞—è —Å—É–º–º–∞ –¥–ª—è –¥–æ—Å—Ä–æ—á–Ω–æ–≥–æ –ø–æ–≥–∞—à–µ–Ω–∏—è">‚Ñπ</span>
                            </label>
                            <div class="input-suffix" data-suffix="‚ÇΩ">
                                <input type="number" id="prepaymentAmount" class="form-input" value="500000" min="10000" step="10000">
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                –†–µ–≥—É–ª—è—Ä–Ω—ã–µ –¥–æ–ø–ª–∞—Ç—ã
                                <span class="info-tooltip" data-tooltip="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Å—É–º–º–∞ –∫ –æ–±—ã—á–Ω–æ–º—É –ø–ª–∞—Ç–µ–∂—É –∫–∞–∂–¥—ã–π –º–µ—Å—è—Ü">‚Ñπ</span>
                            </label>
                            <div class="input-suffix" data-suffix="‚ÇΩ/–º–µ—Å">
                                <input type="number" id="monthlyExtra" class="form-input" value="10000" min="0" step="1000">
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">–ö–æ–≥–¥–∞ –ø–ª–∞–Ω–∏—Ä—É–µ—Ç–µ –¥–æ—Å—Ä–æ—á–Ω–æ–µ –ø–æ–≥–∞—à–µ–Ω–∏–µ</label>
                            <select id="prepaymentTiming" class="form-select">
                                <option value="0" selected>–°—Ä–∞–∑—É</option>
                                <option value="6">–ß–µ—Ä–µ–∑ 6 –º–µ—Å—è—Ü–µ–≤</option>
                                <option value="12">–ß–µ—Ä–µ–∑ 1 –≥–æ–¥</option>
                                <option value="24">–ß–µ—Ä–µ–∑ 2 –≥–æ–¥–∞</option>
                                <option value="36">–ß–µ—Ä–µ–∑ 3 –≥–æ–¥–∞</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3 class="section-title">–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –≤–ª–æ–∂–µ–Ω–∏—è</h3>
                        
                        <div class="form-group">
                            <label class="form-label">
                                –î–æ—Ö–æ–¥–Ω–æ—Å—Ç—å –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã—Ö –≤–ª–æ–∂–µ–Ω–∏–π
                                <span class="info-tooltip" data-tooltip="–ù–∞–ø—Ä–∏–º–µ—Ä, –¥–µ–ø–æ–∑–∏—Ç, –æ–±–ª–∏–≥–∞—Ü–∏–∏, –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏ –≤ –∞–∫—Ü–∏–∏">‚Ñπ</span>
                            </label>
                            <div class="input-suffix" data-suffix="% –≥–æ–¥–æ–≤—ã—Ö">
                                <input type="number" id="alternativeYield" class="form-input" value="7.5" min="0" max="30" step="0.5">
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">–ù–∞–ª–æ–≥ –Ω–∞ –¥–æ—Ö–æ–¥—ã –æ—Ç –≤–ª–æ–∂–µ–Ω–∏–π</label>
                            <div class="input-suffix" data-suffix="%">
                                <input type="number" id="investmentTax" class="form-input" value="13" min="0" max="50" step="1">
                            </div>
                        </div>
                    </div>

                    <button type="button" class="calculate-btn" onclick="calculatePrepayment()">
                        –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –¥–æ—Å—Ä–æ—á–Ω–æ–µ –ø–æ–≥–∞—à–µ–Ω–∏–µ
                    </button>
                </form>
            </div>

            <div class="results-section" id="resultsSection">
                <div id="resultsContent">
                    <div style="text-align: center; color: #666; padding: 40px 20px;">
                        <p>–ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ñ–æ—Ä–º—É —Å–ª–µ–≤–∞ –∏ –Ω–∞–∂–º–∏—Ç–µ "–†–∞—Å—Å—á–∏—Ç–∞—Ç—å –¥–æ—Å—Ä–æ—á–Ω–æ–µ –ø–æ–≥–∞—à–µ–Ω–∏–µ" –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–¥—Ä–æ–±–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="strategy-tabs" id="strategyTabs" style="display: none;">
            <button class="tab-btn active" onclick="switchStrategy('reduce_term')">–°–æ–∫—Ä–∞—â–µ–Ω–∏–µ —Å—Ä–æ–∫–∞</button>
            <button class="tab-btn" onclick="switchStrategy('reduce_payment')">–£–º–µ–Ω—å—à–µ–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞</button>
            <button class="tab-btn" onclick="switchStrategy('mixed')">–°–º–µ—à–∞–Ω–Ω–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è</button>
        </div>

        <div class="comparison-section" id="comparisonSection" style="display: none;">
            <h3 class="section-title">–°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–π</h3>
            <div id="comparisonContent"></div>
        </div>

        <div class="comparison-section" id="chartSection" style="display: none;">
            <h3 class="section-title">–ì—Ä–∞—Ñ–∏–∫ –ø–æ–≥–∞—à–µ–Ω–∏—è</h3>
            <div class="chart-container">
                <canvas id="prepaymentChart"></canvas>
            </div>
        </div>

        <div class="comparison-section" id="alternativeSection" style="display: none;">
            <h3 class="section-title">–ê–Ω–∞–ª–∏–∑ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã—Ö –≤–ª–æ–∂–µ–Ω–∏–π</h3>
            <div id="alternativeContent"></div>
        </div>
    </div>

    <script>
        let prepaymentChart;
        let calculationData = {};

        function calculatePrepayment() {
            const params = getInputValues();
            
            if (!validateInputs(params)) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è');
                return;
            }

            calculationData = {
                withoutPrepayment: calculateWithoutPrepayment(params),
                reduceTerm: calculateReduceTerm(params),
                reducePayment: calculateReducePayment(params),
                mixed: calculateMixed(params),
                alternative: calculateAlternative(params)
            };

            displayResults();
            showSections();
        }

        function getInputValues() {
            return {
                remainingDebt: parseFloat(document.getElementById('remainingDebt').value),
                interestRate: parseFloat(document.getElementById('interestRate').value) / 100,
                remainingTerm: parseInt(document.getElementById('remainingTerm').value),
                currentPayment: parseFloat(document.getElementById('currentPayment').value),
                prepaymentAmount: parseFloat(document.getElementById('prepaymentAmount').value) || 0,
                monthlyExtra: parseFloat(document.getElementById('monthlyExtra').value) || 0,
                prepaymentTiming: parseInt(document.getElementById('prepaymentTiming').value),
                alternativeYield: parseFloat(document.getElementById('alternativeYield').value) / 100,
                investmentTax: parseFloat(document.getElementById('investmentTax').value) / 100
            };
        }

        function validateInputs(params) {
            return params.remainingDebt > 0 && 
                   params.interestRate >= 0 && 
                   params.remainingTerm > 0 && 
                   params.currentPayment > 0;
        }

        function calculateWithoutPrepayment(params) {
            const monthlyRate = params.interestRate / 12;
            const totalMonths = params.remainingTerm * 12;
            
            const monthlyPayment = params.remainingDebt * 
                (monthlyRate * Math.pow(1 + monthlyRate, totalMonths)) / 
                (Math.pow(1 + monthlyRate, totalMonths) - 1);
                
            const totalPayment = monthlyPayment * totalMonths;
            const totalInterest = totalPayment - params.remainingDebt;
            
            return {
                monthlyPayment,
                totalPayment,
                totalInterest,
                termMonths: totalMonths,
                termYears: params.remainingTerm
            };
        }

        function calculateReduceTerm(params) {
            return calculatePrepaymentScenario(params, 'reduce_term');
        }

        function calculateReducePayment(params) {
            return calculatePrepaymentScenario(params, 'reduce_payment');
        }

        function calculateMixed(params) {
            return calculatePrepaymentScenario(params, 'mixed');
        }

        function calculatePrepaymentScenario(params, strategy) {
            let balance = params.remainingDebt;
            let totalPayment = 0;
            let month = 0;
            const monthlyRate = params.interestRate / 12;
            let currentMonthlyPayment = params.currentPayment;
            const schedule = [];

            // –î–æ—Å—Ä–æ—á–Ω—ã–π –ø–ª–∞—Ç—ë–∂ —á–µ—Ä–µ–∑ —É–∫–∞–∑–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è
            while (balance > 0 && month < params.remainingTerm * 12) {
                month++;
                
                const interestPayment = balance * monthlyRate;
                let principalPayment = currentMonthlyPayment - interestPayment;
                
                // –î–æ–±–∞–≤–ª—è–µ–º —Ä–µ–≥—É–ª—è—Ä–Ω—ã–µ –¥–æ–ø–ª–∞—Ç—ã
                if (params.monthlyExtra > 0) {
                    principalPayment += params.monthlyExtra;
                }
                
                // –î–æ–±–∞–≤–ª—è–µ–º –µ–¥–∏–Ω–æ—Ä–∞–∑–æ–≤—ã–π –¥–æ—Å—Ä–æ—á–Ω—ã–π –ø–ª–∞—Ç—ë–∂
                if (month === params.prepaymentTiming + 1 && params.prepaymentAmount > 0) {
                    principalPayment += params.prepaymentAmount;
                }
                
                if (principalPayment > balance) {
                    principalPayment = balance;
                }
                
                const payment = interestPayment + principalPayment;
                balance -= principalPayment;
                totalPayment += payment;
                
                if (month <= 12 || month % 12 === 0) {
                    schedule.push({
                        month,
                        payment,
                        principal: principalPayment,
                        interest: interestPayment,
                        balance: Math.max(balance, 0)
                    });
                }
                
                // –ü–µ—Ä–µ—Å—á—ë—Ç –ø–ª–∞—Ç–µ–∂–∞ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Å—Ç—Ä–∞—Ç–µ–≥–∏–π
                if (month === params.prepaymentTiming + 1 && params.prepaymentAmount > 0) {
                    if (strategy === 'reduce_payment' && balance > 0) {
                        const remainingMonths = params.remainingTerm * 12 - month;
                        currentMonthlyPayment = balance * 
                            (monthlyRate * Math.pow(1 + monthlyRate, remainingMonths)) / 
                            (Math.pow(1 + monthlyRate, remainingMonths) - 1);
                    }
                }
                
                if (balance <= 0) break;
            }
            
            const totalInterest = totalPayment - params.remainingDebt;
            const savedInterest = calculationData.withoutPrepayment ? 
                calculationData.withoutPrepayment.totalInterest - totalInterest : 0;
            
            return {
                monthlyPayment: currentMonthlyPayment,
                totalPayment,
                totalInterest,
                savedInterest,
                termMonths: month,
                termYears: Math.ceil(month / 12),
                schedule
            };
        }

        function calculateAlternative(params) {
            const investmentAmount = params.prepaymentAmount;
            const monthlyInvestment = params.monthlyExtra;
            const netYield = params.alternativeYield * (1 - params.investmentTax);
            
            // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –¥–æ—Ö–æ–¥ –æ—Ç –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã—Ö –≤–ª–æ–∂–µ–Ω–∏–π
            const years = params.remainingTerm;
            let totalInvestment = investmentAmount;
            let futureValue = investmentAmount;
            
            // –ö–æ–º–ø–∞—É–Ω–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω–æ–π —Å—É–º–º—ã
            futureValue *= Math.pow(1 + netYield, years);
            
            // –î–æ–±–∞–≤–ª—è–µ–º –µ–∂–µ–º–µ—Å—è—á–Ω—ã–µ –≤–ª–æ–∂–µ–Ω–∏—è
            if (monthlyInvestment > 0) {
                const monthlyYield = netYield / 12;
                const months = years * 12;
                const monthlyFV = monthlyInvestment * 
                    ((Math.pow(1 + monthlyYield, months) - 1) / monthlyYield);
                futureValue += monthlyFV;
                totalInvestment += monthlyInvestment * months;
            }
            
            const investmentProfit = futureValue - totalInvestment;
            
            return {
                totalInvestment,
                futureValue,
                investmentProfit,
                netYield: netYield * 100
            };
        }

        function displayResults() {
            const base = calculationData.withoutPrepayment;
            const optimal = findOptimalStrategy();
            
            const resultsHTML = `
                <div class="result-highlight">
                    <div class="result-main">${formatCurrency(optimal.savedInterest)}</div>
                    <div class="result-label">–≠–∫–æ–Ω–æ–º–∏—è –Ω–∞ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö</div>
                </div>

                <div class="results-grid">
                    <div class="result-item">
                        <div class="result-value">${formatCurrency(optimal.monthlyPayment)}</div>
                        <div class="result-desc">–ù–æ–≤—ã–π –µ–∂–µ–º–µ—Å—è—á–Ω—ã–π –ø–ª–∞—Ç—ë–∂</div>
                    </div>
                    <div class="result-item">
                        <div class="result-value">${optimal.termYears} –ª–µ—Ç</div>
                        <div class="result-desc">–ù–æ–≤—ã–π —Å—Ä–æ–∫ –∫—Ä–µ–¥–∏—Ç–∞</div>
                    </div>
                    <div class="result-item">
                        <div class="result-value">${formatCurrency(base.totalInterest - optimal.totalInterest)}</div>
                        <div class="result-desc">–≠–∫–æ–Ω–æ–º–∏—è –Ω–∞ –ø–µ—Ä–µ–ø–ª–∞—Ç–µ</div>
                    </div>
                    <div class="result-item">
                        <div class="result-value">${((base.termYears - optimal.termYears) * 12).toFixed(0)} –º–µ—Å</div>
                        <div class="result-desc">–°–æ–∫—Ä–∞—â–µ–Ω–∏–µ —Å—Ä–æ–∫–∞</div>
                    </div>
                </div>

                <div class="savings-highlight">
                    <div class="savings-amount">${formatCurrency(optimal.savedInterest)}</div>
                    <div>–û–±—â–∞—è –≤—ã–≥–æ–¥–∞ –æ—Ç –¥–æ—Å—Ä–æ—á–Ω–æ–≥–æ –ø–æ–≥–∞—à–µ–Ω–∏—è</div>
                </div>

                <div class="export-buttons">
                    <button class="export-btn" onclick="exportToExcel()">üìä –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel</button>
                    <button class="export-btn" onclick="exportToPDF()">üìÑ –≠–∫—Å–ø–æ—Ä—Ç –≤ PDF</button>
                    <button class="export-btn" onclick="saveCalculation()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–∞—Å—á—ë—Ç</button>
                </div>

                <div class="chart-container">
                    <canvas id="savingsChart"></canvas>
                </div>
            `;

            document.getElementById('resultsContent').innerHTML = resultsHTML;
            createSavingsChart();
        }

        function findOptimalStrategy() {
            const strategies = [
                calculationData.reduceTerm,
                calculationData.reducePayment,
                calculationData.mixed
            ];
            
            return strategies.reduce((best, current) => 
                current.savedInterest > best.savedInterest ? current : best
            );
        }

        function displayComparison() {
            const strategies = [
                { name: '–ë–µ–∑ –¥–æ—Å—Ä–æ—á–Ω–æ–≥–æ –ø–æ–≥–∞—à–µ–Ω–∏—è', data: calculationData.withoutPrepayment },
                { name: '–°–æ–∫—Ä–∞—â–µ–Ω–∏–µ —Å—Ä–æ–∫–∞', data: calculationData.reduceTerm },
                { name: '–£–º–µ–Ω—å—à–µ–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞', data: calculationData.reducePayment },
                { name: '–°–º–µ—à–∞–Ω–Ω–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è', data: calculationData.mixed }
            ];

            let tableHTML = `
                <table class="comparison-table">
                    <thead>
                        <tr>
                            <th>–°—Ç—Ä–∞—Ç–µ–≥–∏—è</th>
                            <th>–ï–∂–µ–º–µ—Å—è—á–Ω—ã–π –ø–ª–∞—Ç—ë–∂</th>
                            <th>–°—Ä–æ–∫ –∫—Ä–µ–¥–∏—Ç–∞</th>
                            <th>–û–±—â–∞—è –ø–µ—Ä–µ–ø–ª–∞—Ç–∞</th>
                            <th>–≠–∫–æ–Ω–æ–º–∏—è</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            strategies.forEach(strategy => {
                const savings = strategy.data.savedInterest || 0;
                tableHTML += `
                    <tr>
                        <td>${strategy.name}</td>
                        <td>${formatCurrency(strategy.data.monthlyPayment)}</td>
                        <td>${strategy.data.termYears} –ª–µ—Ç</td>
                        <td>${formatCurrency(strategy.data.totalInterest)}</td>
                        <td style="color: ${savings > 0 ? '#28a745' : '#333'}">${formatCurrency(savings)}</td>
                    </tr>
                `;
            });

            tableHTML += '</tbody></table>';
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∞–Ω–∞–ª–∏–∑ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã—Ö –≤–ª–æ–∂–µ–Ω–∏–π
            const alt = calculationData.alternative;
            tableHTML += `
                <h4 style="margin-top: 32px; margin-bottom: 16px;">–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –≤–ª–æ–∂–µ–Ω–∏—è</h4>
                <div class="results-grid">
                    <div class="result-item">
                        <div class="result-value">${formatCurrency(alt.futureValue)}</div>
                        <div class="result-desc">–°—Ç–æ–∏–º–æ—Å—Ç—å –≤–ª–æ–∂–µ–Ω–∏–π —á–µ—Ä–µ–∑ ${getInputValues().remainingTerm} –ª–µ—Ç</div>
                    </div>
                    <div class="result-item">
                        <div class="result-value">${formatCurrency(alt.investmentProfit)}</div>
                        <div class="result-desc">–ü—Ä–∏–±—ã–ª—å –æ—Ç –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã—Ö –≤–ª–æ–∂–µ–Ω–∏–π</div>
                    </div>
                </div>
                
                <div style="margin-top: 16px; padding: 16px; background: #fff3cd; border-radius: 6px; border-left: 4px solid #ffc107;">
                    <strong>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:</strong> ${alt.investmentProfit > findOptimalStrategy().savedInterest ? 
                        '–í—ã–≥–æ–¥–Ω–µ–µ –∏–Ω–≤–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–≤–æ–±–æ–¥–Ω—ã–µ —Å—Ä–µ–¥—Å—Ç–≤–∞, —á–µ–º –¥–æ—Å—Ä–æ—á–Ω–æ –ø–æ–≥–∞—à–∞—Ç—å –∏–ø–æ—Ç–µ–∫—É' : 
                        '–î–æ—Å—Ä–æ—á–Ω–æ–µ –ø–æ–≥–∞—à–µ–Ω–∏–µ –∏–ø–æ—Ç–µ–∫–∏ –≤—ã–≥–æ–¥–Ω–µ–µ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã—Ö –≤–ª–æ–∂–µ–Ω–∏–π'}
                </div>
            `;

            document.getElementById('comparisonContent').innerHTML = tableHTML;
        }

        function createSavingsChart() {
            const ctx = document.getElementById('savingsChart').getContext('2d');
            
            if (window.savingsChartInstance) {
                window.savingsChartInstance.destroy();
            }

            const base = calculationData.withoutPrepayment;
            const optimal = findOptimalStrategy();
            
            window.savingsChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['–°—ç–∫–æ–Ω–æ–º–ª–µ–Ω–æ', '–ö –¥–æ–ø–ª–∞—Ç–µ'],
                    datasets: [{
                        data: [optimal.savedInterest, optimal.totalInterest],
                        backgroundColor: ['#28a745', '#007bff'],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.label + ': ' + formatCurrency(context.raw);
                                }
                            }
                        }
                    }
                }
            });
        }

        function createPrepaymentChart() {
            const ctx = document.getElementById('prepaymentChart').getContext('2d');
            
            if (prepaymentChart) {
                prepaymentChart.destroy();
            }

            const base = calculationData.withoutPrepayment.schedule || [];
            const optimal = findOptimalStrategy().schedule || [];
            
            prepaymentChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: optimal.map(d => `–ú–µ—Å—è—Ü ${d.month}`),
                    datasets: [
                        {
                            label: '–û—Å—Ç–∞—Ç–æ–∫ –¥–æ–ª–≥–∞ —Å –¥–æ—Å—Ä–æ—á–Ω—ã–º –ø–æ–≥–∞—à–µ–Ω–∏–µ–º',
                            data: optimal.map(d => d.balance),
                            borderColor: '#28a745',
                            backgroundColor: 'transparent',
                            tension: 0.4
                        },
                        {
                            label: '–û—Å—Ç–∞—Ç–æ–∫ –¥–æ–ª–≥–∞ –±–µ–∑ –¥–æ—Å—Ä–æ—á–Ω–æ–≥–æ –ø–æ–≥–∞—à–µ–Ω–∏—è',
                            data: base.map(d => d.balance),
                            borderColor: '#dc3545',
                            backgroundColor: 'transparent',
                            borderDash: [5, 5],
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: '–î–∏–Ω–∞–º–∏–∫–∞ –ø–æ–≥–∞—à–µ–Ω–∏—è –∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç–∏'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        }
                    }
                }
            });
        }

        function showSections() {
            document.getElementById('strategyTabs').style.display = 'flex';
            document.getElementById('comparisonSection').style.display = 'block';
            document.getElementById('chartSection').style.display = 'block';
            document.getElementById('alternativeSection').style.display = 'block';
            
            displayComparison();
            createPrepaymentChart();
        }

        function switchStrategy(strategy) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É —Ä–∞–∑–ª–∏—á–Ω—ã–º–∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏—è–º–∏
            displayComparison();
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('ru-RU', {
                style: 'currency',
                currency: 'RUB',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        }

        function exportToExcel() {
            alert('–§—É–Ω–∫—Ü–∏—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –≤ Excel –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ —Å–ª–µ–¥—É—é—â–µ–π –≤–µ—Ä—Å–∏–∏');
        }

        function exportToPDF() {
            alert('–§—É–Ω–∫—Ü–∏—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –≤ PDF –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ —Å–ª–µ–¥—É—é—â–µ–π –≤–µ—Ä—Å–∏–∏');
        }

        function saveCalculation() {
            const data = {
                inputs: getInputValues(),
                results: calculationData,
                timestamp: new Date().toISOString()
            };
            
            localStorage.setItem('prepaymentCalculation', JSON.stringify(data));
            alert('–†–∞—Å—á—ë—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤ –±—Ä–∞—É–∑–µ—Ä–µ');
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á—ë—Ç –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', function() {
            calculatePrepayment();
        });
    </script>
</body>
</html>