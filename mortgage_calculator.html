<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>М2 — Ипотечный калькулятор</title>
    <meta name="description" content="Точный ипотечный калькулятор от М2. Рассчитайте ежемесячный платеж, переплату, досрочные погашения. Расчеты по российскому законодательству.">
    <meta name="keywords" content="ипотечный калькулятор, ипотека, недвижимость, М2, расчет ипотеки, ежемесячный платеж">
    <meta property="og:title" content="М2 — Ипотечный калькулятор">
    <meta property="og:description" content="Точный ипотечный калькулятор от М2. Рассчитайте ежемесячный платеж, переплату, досрочные погашения.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://m2-calculators-dfol1ftj8-nikita-tita-projects.vercel.app/mortgage_calculator.html">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="М2 — Ипотечный калькулятор">
    <meta name="twitter:description" content="Точный ипотечный калькулятор от М2. Рассчитайте ежемесячный платеж, переплату, досрочные погашения.">
    
    <!-- Favicon and Icons -->
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="manifest" href="/manifest.json">
    <link rel="stylesheet" href="m2-theme.css">
    <link rel="stylesheet" href="m2-header.css">
    <link rel="stylesheet" href="m2-ui-components.css">
    <link rel="stylesheet" href="quick-fixes.css">
    <meta name="theme-color" content="#4F2CD9">
    <link rel="apple-touch-icon" href="/icons/icon-192x192.png">
    
    <!-- Яндекс.Метрика -->
    <script type="text/javascript" >
       (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
       m[i].l=1*new Date();
       for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
       k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
       (window, document, "script", "https://mc.yandex.ru/metrika/tag.js?id=104341432", "ym");

       ym(104341432, "init", {
            clickmap:true,
            trackLinks:true,
            accurateTrackBounce:true,
            webvisor:true,
            trackHash:true
       });
    </script>
    <noscript><div><img src="https://mc.yandex.ru/watch/104341432" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
    <!-- /Яндекс.Метрика -->

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="tooltip-system.js"></script>
    <script src="calculator-storage.js"></script>
    <script src="pdf-export.js"></script>
    <script src="components.js"></script>
    <script src="advanced-ux-enhancements.js"></script>
    <script src="analytics.js"></script>
    <script src="client-share.js"></script>
    <script src="m2-enhancements-loader.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #FFFFFF;
            color: #333;
            line-height: 1.5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 50px;
            padding-bottom: 30px;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }

        .logo {
            color: #4F2CD9 !important;
            font-size: 48px;
            font-weight: 700;
            background: linear-gradient(90deg, #0f2027, #2c5364);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 15px;
        }

        .title {
            font-size: 36px;
            font-weight: 700;
            color: #1a1a1a;
            margin-bottom: 15px;
        }

        .subtitle {
            font-size: 18px;
            color: #555;
            max-width: 700px;
            margin: 0 auto;
            line-height: 1.6;
        }

        .back-link {
            color: #4F2CD9 !important;
            color: #007bff;
            text-decoration: none;
            font-size: 14px;
            margin-bottom: 20px;
            display: inline-block;
        }

        .back-link:hover {
            text-decoration: underline;
        }

        /* Mode Switch */
        .mode-switch {
            display: flex;
            justify-content: center;
            margin-bottom: 40px;
        }

        .mode-toggle {
            background: white;
            border-radius: 12px;
            padding: 4px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
            display: flex;
            border: 1px solid #e9ecef;
        }

        .mode-btn {
            padding: 12px 24px;
            border: none;
            background: transparent;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #4F2CD9;
        }

        .mode-btn.active {
            background: #4F2CD9;
            color: white;
            box-shadow: 0 2px 8px rgba(79, 44, 217, 0.3);
        }

        /* Calculator Layout */
        .calculator {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 32px;
            margin-bottom: 40px;
        }

        .calculator.basic-mode {
            grid-template-columns: 1fr;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }

        .inputs, .results {
            background: white;
            border-radius: 16px;
            padding: 28px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        .section-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 24px;
            color: #333;
        }

        .input-group {
            margin-bottom: 24px;
            position: relative;
        }
        
        /* Группировка по законам гештальта */
        .input-section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
            border-left: 4px solid #007bff;
        }
        
        .section-header {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .input-label {
            display: block;
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }

        .input-field {
            width: 100%;
            padding: 16px;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            font-size: 16px;
            background: white;
            transition: all 0.3s ease;
            appearance: textfield;
            min-height: 48px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.02);
        }
        
        .input-field:focus {
            border-color: #2c5364;
            outline: none;
            box-shadow: 0 0 0 4px rgba(44, 83, 100, 0.1);
        }
        
        .input-field:hover {
            border-color: #ccc;
        }

        .input-field:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
            transform: scale(1.005);
        }
        
        .input-field.calculating {
            background: linear-gradient(90deg, #f8f9fa 0%, #e9ecef 50%, #f8f9fa 100%);
            background-size: 200% 100%;
            animation: shimmer 1s infinite;
        }
        
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        .input-field::-webkit-outer-spin-button,
        .input-field::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .quick-buttons {
            display: flex;
            gap: 8px;
            margin-top: 8px;
            flex-wrap: wrap;
        }

        .quick-btn {
            background: #4F2CD9;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s ease;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            white-space: nowrap;
        }

        .quick-btn:hover, .quick-btn.active {
            background: #3F23AE;
        }

        .select-field {
            width: 100%;
            padding: 16px;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            font-size: 16px;
            background: white;
            cursor: pointer;
        }

        .select-field:focus {
            outline: none;
            border-color: #007bff;
        }

        /* Results */
        .result-item {
            margin-bottom: 24px;
        }

        .result-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 4px;
        }

        .result-value {
            font-size: 28px;
            font-weight: 700;
            color: #333;
        }

        .result-value.primary {
            color: #007bff;
            font-size: 36px;
        }

        /* Basic Mode Results */
        .basic-result {
            text-align: center;
            padding: 40px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        .basic-result .result-value {
            font-size: 48px;
            color: #007bff;
            margin-bottom: 12px;
        }

        .basic-result .result-label {
            font-size: 18px;
            color: #666;
        }
        
        .basic-summary {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e9ecef;
        }
        
        .summary-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
        }
        
        .summary-label {
            color: #666;
        }
        
        .summary-value {
            font-weight: 600;
            color: #333;
        }

        /* Advanced Mode Features */
        .advanced-features {
            display: none;
        }

        .advanced-features.active {
            display: block;
        }

        .chart-container {
            margin-top: 32px;
            padding: 24px;
            background: #f8f9fa;
            border-radius: 12px;
        }

        .chart-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            text-align: center;
            color: #333;
        }

        .pie-chart {
            width: 200px;
            height: 200px;
            margin: 0 auto 20px;
            position: relative;
        }

        .pie-chart svg {
            width: 100%;
            height: 100%;
            transform: rotate(-90deg);
        }

        .legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 4px;
        }

        .payment-breakdown {
            background: white;
            border-radius: 16px;
            padding: 28px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            margin-bottom: 40px;
        }

        .breakdown-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 24px;
            margin-top: 20px;
        }

        .breakdown-item {
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
        }

        .breakdown-number {
            font-size: 24px;
            font-weight: 700;
            color: #007bff;
            margin-bottom: 8px;
        }

        .breakdown-label {
            font-size: 14px;
            color: #666;
        }

        /* Payment Schedule */
        .payment-schedule {
            background: white;
            border-radius: 16px;
            padding: 28px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            margin-bottom: 40px;
        }

        .schedule-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .schedule-table th,
        .schedule-table td {
            padding: 12px;
            text-align: right;
            border-bottom: 1px solid #e9ecef;
        }

        .schedule-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }

        .schedule-table tbody tr:hover {
            background: #f8f9fa;
        }

        /* Calculation Details */
        .calculation-details {
            background: #f8f9fa;
            border-radius: 12px;
            margin: 32px 0;
            overflow: hidden;
            border: 1px solid #e9ecef;
        }

        .details-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            background: white;
            border-bottom: 1px solid #e9ecef;
        }

        .details-header h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }

        .details-toggle {
            background: none;
            border: none;
            color: #007bff;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: 6px;
            transition: background 0.2s ease;
        }

        .details-toggle:hover {
            background: #f8f9fa;
        }

        .toggle-icon {
            transition: transform 0.3s ease;
        }

        .details-toggle.active .toggle-icon {
            transform: rotate(180deg);
        }

        .details-content {
            padding: 0 24px;
            max-height: 0;
            opacity: 0;
            overflow: hidden;
            transition: all 0.4s ease;
        }

        .details-content.show {
            max-height: 800px;
            opacity: 1;
            padding: 24px;
        }

        .detail-step {
            display: flex;
            gap: 20px;
            margin-bottom: 24px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .detail-step:last-child {
            margin-bottom: 0;
        }

        .step-number {
            width: 32px;
            height: 32px;
            background: #007bff;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 16px;
            flex-shrink: 0;
        }

        .step-content {
            flex: 1;
        }

        .step-content h4 {
            margin: 0 0 12px 0;
            font-size: 16px;
            color: #333;
            font-weight: 600;
        }

        .formula {
            background: #e3f2fd;
            padding: 12px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            margin-bottom: 8px;
            color: #1565c0;
            border-left: 4px solid #2196f3;
        }

        .formula-explanation {
            font-size: 13px;
            color: #666;
            margin-bottom: 8px;
            font-style: italic;
        }

        .calculation {
            background: #f1f8e9;
            padding: 12px;
            border-radius: 6px;
            font-weight: 500;
            color: #2e7d32;
            border-left: 4px solid #4caf50;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 16px;
            justify-content: center;
            margin-top: 40px;
            flex-wrap: wrap;
        }

        .btn, .btn-primary {
            background: #4F2CD9;
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s ease;
            min-height: 48px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }

        .btn:hover, .btn-primary:hover {
            background: #3F23AE;
        }

        .btn-secondary {
            background: #797981;
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s ease;
            min-height: 48px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-secondary:hover {
            background: #5A5A61;
        }

        /* Early Payment Section */
        .early-payment {
            background: white;
            border-radius: 16px;
            padding: 28px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            margin-bottom: 40px;
        }

        .early-payment-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .early-payment-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .early-payment-item input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            font-size: 14px;
        }

        .early-payment-item button {
            padding: 8px 12px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
        }

        .early-payment-item button:hover {
            background: #c82333;
        }

        /* Улучшенная адаптивность для мобильных устройств */
        @media (max-width: 768px) {
            .calculator {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .calculator.basic-mode {
                max-width: none;
            }

            .container {
                padding: 16px 12px;
            }

            .header h1 {
                font-size: 28px;
            }

            .header-content {
                flex-direction: column;
                gap: 16px;
            }

            .inputs, .results, .payment-breakdown, .payment-schedule, .early-payment {
                padding: 20px 16px;
            }

            .input-field, .input-field select {
                font-size: 16px; /* Предотвращает zoom на iOS */
                padding: 14px; /* Больше для touch */
                min-height: 48px; /* Минимум для touch-friendly */
            }

            .quick-buttons {
                gap: 8px;
            }

            .quick-btn {
                padding: 12px 16px; /* Больше touch-область */
                font-size: 14px;
                min-height: 44px; /* iOS рекомендует минимум 44px */
            }

            .breakdown-grid {
                grid-template-columns: 1fr;
            }

            .legend {
                flex-direction: column;
                align-items: center;
                gap: 12px;
            }

            .basic-result .result-value {
                font-size: 32px;
            }

            .action-buttons {
                flex-direction: column;
                align-items: stretch;
                gap: 12px;
            }

            .btn {
                width: 100%;
                justify-content: center;
                min-height: 48px;
                font-size: 16px;
            }

            .schedule-table {
                font-size: 13px;
                display: block;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .schedule-table th,
            .schedule-table td {
                padding: 10px 8px;
                white-space: nowrap;
            }

            .mode-buttons {
                width: 100%;
            }

            .mode-btn {
                flex: 1;
                min-height: 44px;
                font-size: 15px;
            }

            /* Скрываем сложные элементы на маленьких экранах по умолчанию */
            .advanced-features {
                display: none;
            }

            .advanced-features.active {
                display: block;
            }
        }

        /* Дополнительные оптимизации для очень маленьких экранов */
        @media (max-width: 375px) {
            .container {
                padding: 12px 8px;
            }

            .header h1 {
                font-size: 24px;
            }

            .quick-btn {
                padding: 10px 12px;
                font-size: 13px;
            }

            .basic-result .result-value {
                font-size: 28px;
            }

            .section-title {
                font-size: 20px;
            }
        }

        /* Оптимизация для планшетов в портретной ориентации */
        @media (min-width: 769px) and (max-width: 1024px) {
            .calculator {
                grid-template-columns: 1fr;
                max-width: 700px;
                margin: 0 auto;
            }
        }
        }
    </style>
</head>
<body>
    <!-- M2.ru Header -->
    <header class="m2-header">
        <div class="m2-header-content">
            <!-- Logo -->
            <div class="m2-header-logo">
                <a href="https://m2.ru/" target="_blank" rel="noopener">
                    <svg width="58" height="52" viewBox="0 0 58 52" fill="none">
                        <path fill-rule="evenodd" clip-rule="evenodd" d="M17 0H58V41H41V52H0V11H17V0Z" fill="#3216B5"></path>
                        <path d="M44.157 27.392V24.6531H37.5997V24.6298C39.9124 23.6013 43.9483 21.8471 43.9483 18.1997C43.9483 15.3184 41.5538 12.8572 38.1712 12.8572C34.7887 12.8572 33.0611 15.1883 32.3001 17.2899L34.8036 18.2698C35.3685 16.5165 36.363 15.4468 38.1945 15.4468C39.794 15.4468 41.1117 16.6404 40.9809 18.223C40.8122 20.2646 38.6293 21.7447 36.6206 22.8487C35.0867 23.692 32.7112 24.889 32.7112 24.889V27.392H44.157Z" fill="white"></path>
                        <path d="M12.0522 24.663V38.3574H15.0083V28.0866L19.2383 38.3574H21.4807L25.6344 28.0866V38.3574H28.6158V24.663H24.3094L20.334 34.4851L16.3333 24.663H12.0522Z" fill="white"></path>
                    </svg>
                </a>
            </div>

            <!-- Navigation -->
            <nav class="m2-header-nav">
                <div class="m2-header-nav-menu">
                    <a href="https://m2.ru/moskva/novostroyki/" target="_blank" rel="noopener" class="m2-header-nav-link">Новостройки</a>
                    <a href="https://m2.ru/ipoteka/" target="_blank" rel="noopener" class="m2-header-nav-link">Ипотека</a>
                    <a href="https://m2.ru/services/deal/" target="_blank" rel="noopener" class="m2-header-nav-link">Сделка</a>
                    <a href="index.html" class="m2-header-nav-link m2-header-nav-link-active">Калькуляторы</a>
                </div>
            </nav>

            <!-- User Actions -->
            <div class="m2-header-actions">
                <a href="https://m2.ru/login/" target="_blank" rel="noopener" class="m2-header-login-btn">Войти</a>
            </div>
        </div>
    </header>

    <div class="container">
        <a href="index.html" class="back-link">← Вернуться к калькуляторам</a>

        <div class="header">
            <h1 class="title">Ипотечный калькулятор</h1>
            <p class="subtitle">Рассчитайте ежемесячный платеж и общую переплату</p>
        </div>

        <!-- Mode Switch -->
        <div class="mode-switch">
            <div class="mode-toggle">
                <button class="mode-btn active" onclick="switchMode('basic')">Базовый</button>
                <button class="mode-btn" onclick="switchMode('advanced')">Расширенный</button>
            </div>
        </div>

        <div class="calculator basic-mode" id="calculatorContainer">
            <div class="inputs">
                <h2 class="section-title">Параметры кредита</h2>
                
                <div class="input-group">
                    <label class="input-label" for="propertyPrice">Стоимость недвижимости</label>
                    <input type="number" id="propertyPrice" class="input-field" value="8000000" min="500000" max="50000000" step="100000">
                    <div class="quick-buttons">
                        <button class="quick-btn" onclick="setValue('propertyPrice', 3000000)">3 млн</button>
                        <button class="quick-btn" onclick="setValue('propertyPrice', 5000000)">5 млн</button>
                        <button class="quick-btn" onclick="setValue('propertyPrice', 8000000)">8 млн</button>
                        <button class="quick-btn" onclick="setValue('propertyPrice', 12000000)">12 млн</button>
                    </div>
                </div>

                <div class="input-group">
                    <label class="input-label" for="downPayment">Первоначальный взнос (собственные средства)</label>
                    <input type="number" id="downPayment" class="input-field" value="2400000" min="0" step="50000">
                    <div class="quick-buttons">
                        <button class="quick-btn" onclick="setPercentage('downPayment', 15)" title="15% - минимум">15%</button>
                        <button class="quick-btn" onclick="setPercentage('downPayment', 20)">20%</button>
                        <button class="quick-btn" onclick="setPercentage('downPayment', 30)">30%</button>
                        <button class="quick-btn" onclick="setPercentage('downPayment', 50)">50%</button>
                    </div>
                    <small style="color: #666; font-size: 12px; margin-top: 4px; display: block;">Минимум 15% от стоимости недвижимости</small>
                </div>

                <div class="input-group advanced-features">
                    <label class="input-label" for="maternalCapital">Материнский капитал</label>
                    <input type="number" id="maternalCapital" class="input-field" value="0" min="0" step="10000">
                    <div class="quick-buttons">
                        <button class="quick-btn" onclick="setValue('maternalCapital', 0)">Нет</button>
                        <button class="quick-btn" onclick="setValue('maternalCapital', 630000)">630 тыс</button>
                        <button class="quick-btn" onclick="setValue('maternalCapital', 775000)">775 тыс</button>
                    </div>
                    <small style="color: #666; font-size: 12px; margin-top: 4px; display: block;">Добавляется к первоначальному взносу</small>
                </div>

                <div class="input-group advanced-features">
                    <label class="input-label" for="subsidyType">Программа субсидий</label>
                    <select id="subsidyType" class="input-field" onchange="calculateMortgage()">
                        <option value="none">Нет субсидий</option>
                        <option value="family">Семейная ипотека (до 6%)</option>
                        <option value="it">IT-ипотека (до 5%)</option>
                        <option value="military">Военная ипотека (5.9%)</option>
                        <option value="rural">Сельская ипотека (до 3%)</option>
                        <option value="dv">Дальневосточная (до 2%)</option>
                    </select>
                    <small style="color: #666; font-size: 12px; margin-top: 4px; display: block;">Автоматически снижает процентную ставку</small>
                </div>

                <div class="input-group">
                    <label class="input-label" for="interestRate">Процентная ставка, %</label>
                    <input type="number" id="interestRate" class="input-field" value="8.5" min="1" max="30" step="0.1">
                    <div class="quick-buttons">
                        <button class="quick-btn" onclick="setValue('interestRate', 7.5)">7.5%</button>
                        <button class="quick-btn" onclick="setValue('interestRate', 8.5)">8.5%</button>
                        <button class="quick-btn" onclick="setValue('interestRate', 9.5)">9.5%</button>
                        <button class="quick-btn" onclick="setValue('interestRate', 11)">11%</button>
                    </div>
                </div>

                <div class="input-group">
                    <label class="input-label" for="loanTerm">Срок кредита, лет</label>
                    <input type="number" id="loanTerm" class="input-field" value="20" min="1" max="30" step="1">
                    <div class="quick-buttons">
                        <button class="quick-btn" onclick="setValue('loanTerm', 15)">15 лет</button>
                        <button class="quick-btn" onclick="setValue('loanTerm', 20)">20 лет</button>
                        <button class="quick-btn" onclick="setValue('loanTerm', 25)">25 лет</button>
                        <button class="quick-btn" onclick="setValue('loanTerm', 30)">30 лет</button>
                    </div>
                </div>

                <!-- Advanced Mode Fields -->
                <div class="advanced-features">
                    <div class="input-group">
                        <label class="input-label" for="paymentType">Тип платежа</label>
                        <select id="paymentType" class="select-field">
                            <option value="annuity">Аннуитетный</option>
                            <option value="differentiated">Дифференцированный</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Basic Mode Result -->
            <div class="basic-result" id="basicResult">
                <div class="result-value" id="basicMonthlyPayment">52 756 ₽</div>
                <div class="result-label">Ежемесячный платеж</div>
                
                <div class="basic-summary">
                    <div class="summary-item">
                        <span class="summary-label">Сумма кредита:</span>
                        <span class="summary-value" id="basicLoanAmount">5 600 000 ₽</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Переплата банку:</span>
                        <span class="summary-value" id="basicOverpayment">7 061 440 ₽</span>
                    </div>
                </div>
            </div>

            <!-- Advanced Mode Results -->
            <div class="results advanced-features">
                <h2 class="section-title">Результат расчета</h2>
                
                <div class="result-item">
                    <div class="result-label">Ежемесячный платеж</div>
                    <div class="result-value primary" id="monthlyPayment">52 756 ₽</div>
                </div>

                <div class="result-item">
                    <div class="result-label">Сумма кредита</div>
                    <div class="result-value" id="loanAmount">5 600 000 ₽</div>
                </div>

                <div class="result-item">
                    <div class="result-label">Общая переплата</div>
                    <div class="result-value" id="totalOverpayment">7 061 440 ₽</div>
                </div>

                <div class="result-item">
                    <div class="result-label">Общая сумма выплат</div>
                    <div class="result-value" id="totalAmount">12 661 440 ₽</div>
                </div>
                
                <!-- Детализация расчетов -->
                <div class="calculation-details">
                    <div class="details-header">
                        <h3>Как мы считаем</h3>
                        <button type="button" class="details-toggle" onclick="toggleCalculationDetails()">
                            <span class="toggle-text">Показать расчеты</span>
                            <span class="toggle-icon">▼</span>
                        </button>
                    </div>
                    
                    <div class="details-content" id="calculationDetailsContent">
                        <div class="detail-step">
                            <div class="step-number">1</div>
                            <div class="step-content">
                                <h4>Расчет суммы кредита</h4>
                                <div class="formula">Сумма кредита = Стоимость недвижимости - Первоначальный взнос</div>
                                <div class="calculation" id="loanAmountCalculation">7 000 000 - 1 400 000 = 5 600 000 руб.</div>
                            </div>
                        </div>
                        
                        <div class="detail-step">
                            <div class="step-number">2</div>
                            <div class="step-content">
                                <h4>Расчет ежемесячного платежа</h4>
                                <div class="formula">ПМТ = S × [i × (1 + i)^n] / [(1 + i)^n - 1]</div>
                                <div class="formula-explanation">
                                    где S - сумма кредита, i - месячная ставка, n - количество платежей
                                </div>
                                <div class="calculation" id="monthlyPaymentCalculation">
                                    S = 5 600 000 руб., i = 0.01333, n = 240
                                </div>
                            </div>
                        </div>
                        
                        <div class="detail-step">
                            <div class="step-number">3</div>
                            <div class="step-content">
                                <h4>Расчет переплаты</h4>
                                <div class="formula">Переплата = (ПМТ × n) - S</div>
                                <div class="calculation" id="overpaymentCalculation">
                                    (52 756 × 240) - 5 600 000 = 7 061 440 руб.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="chart-container">
                    <div class="chart-title">Структура выплат</div>
                    <div class="pie-chart">
                        <svg viewBox="0 0 200 200">
                            <circle cx="100" cy="100" r="80" fill="none" stroke="#007bff" stroke-width="40" 
                                    stroke-dasharray="0 502" stroke-linecap="round" id="principalArc"/>
                            <circle cx="100" cy="100" r="80" fill="none" stroke="#dc3545" stroke-width="40" 
                                    stroke-dasharray="0 502" stroke-linecap="round" id="interestArc"/>
                        </svg>
                    </div>
                    <div class="legend">
                        <div class="legend-item">
                            <div class="legend-color" style="background: #007bff;"></div>
                            <span>Основной долг: <span id="principalPercent">44.2%</span></span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #dc3545;"></div>
                            <span>Проценты: <span id="interestPercent">55.8%</span></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Advanced Mode Additional Sections -->
        <div class="advanced-features">
            <div class="payment-breakdown">
                <h2 class="section-title">Детализация платежа</h2>
                <div class="breakdown-grid">
                    <div class="breakdown-item">
                        <div class="breakdown-number" id="requiredIncome">131 890 ₽</div>
                        <div class="breakdown-label">Требуемый доход<br>для одобрения</div>
                    </div>
                    <div class="breakdown-item">
                        <div class="breakdown-number" id="firstPaymentPrincipal">13 123 ₽</div>
                        <div class="breakdown-label">Основной долг<br>в 1-м платеже</div>
                    </div>
                    <div class="breakdown-item">
                        <div class="breakdown-number" id="firstPaymentInterest">39 633 ₽</div>
                        <div class="breakdown-label">Проценты<br>в 1-м платеже</div>
                    </div>
                    <div class="breakdown-item">
                        <div class="breakdown-number" id="effectiveRate">8.94%</div>
                        <div class="breakdown-label">Эффективная<br>ставка</div>
                    </div>
                </div>
            </div>

            <!-- Early Payment Section -->
            <div class="early-payment">
                <h2 class="section-title">Досрочное погашение</h2>
                <div class="early-payment-controls">
                    <div class="input-group">
                        <label class="input-label">Месяц платежа</label>
                        <input type="number" id="earlyPaymentMonth" class="input-field" min="1" placeholder="Номер месяца">
                    </div>
                    <div class="input-group">
                        <label class="input-label">Сумма досрочного платежа</label>
                        <input type="number" id="earlyPaymentAmount" class="input-field" min="1000" step="1000" placeholder="Сумма в рублях">
                    </div>
                    <div class="input-group">
                        <label class="input-label">Тип погашения</label>
                        <select id="earlyPaymentType" class="select-field">
                            <option value="reduce_term">Уменьшить срок</option>
                            <option value="reduce_payment">Уменьшить платеж</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <button class="btn btn-secondary" onclick="addEarlyPayment()" style="margin-top: 28px;">Добавить платеж</button>
                    </div>
                </div>
                <div id="earlyPaymentsList"></div>
            </div>

            <!-- Payment Schedule -->
            <div class="payment-schedule">
                <h2 class="section-title">График платежей</h2>
                <p style="color: #666; margin-bottom: 20px;">Первые 12 месяцев графика погашения:</p>
                <div style="overflow-x: auto;">
                    <table class="schedule-table">
                        <thead>
                            <tr>
                                <th>Месяц</th>
                                <th>Платеж</th>
                                <th>Основной долг</th>
                                <th>Проценты</th>
                                <th>Остаток долга</th>
                            </tr>
                        </thead>
                        <tbody id="scheduleTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons">
            <button class="btn btn-primary" onclick="exportToPDF()">
                📄 PDF
            </button>
            <button class="btn btn-primary" onclick="exportToExcel()" style="background: #28a745;">
                📊 Excel
            </button>
            <button class="btn btn-secondary" onclick="openCompareModal()">
                ⚖️ Сравнить
            </button>
            <button class="btn btn-secondary" onclick="resetCalculator()">
                🔄 Сбросить
            </button>
        </div>
    </div>

    <!-- Модальное окно сравнения вариантов -->
    <div id="compareModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 10000; overflow-y: auto; padding: 20px;">
        <div style="max-width: 1200px; margin: 40px auto; background: white; border-radius: 16px; padding: 32px; position: relative;">
            <button onclick="closeCompareModal()" style="position: absolute; top: 16px; right: 16px; background: none; border: none; font-size: 28px; cursor: pointer; color: #666;">&times;</button>

            <h2 style="color: #4F2CD9; margin-bottom: 24px; font-size: 28px;">⚖️ Сравнение вариантов</h2>

            <div id="compareDescription" style="background: #F6F5FF; padding: 16px; border-radius: 8px; margin-bottom: 24px; font-size: 14px; color: #666;">
                Сохраните до 3 вариантов расчёта для сравнения. Измените параметры калькулятора и нажмите "Добавить текущий расчёт".
            </div>

            <div style="margin-bottom: 24px;">
                <button onclick="saveCurrentCalculation()" class="btn btn-primary" style="width: 100%;">
                    ➕ Добавить текущий расчёт
                </button>
            </div>

            <div id="compareGrid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                <!-- Варианты будут добавлены через JS -->
            </div>

            <div id="comparisonTable" style="margin-top: 32px; display: none;">
                <h3 style="margin-bottom: 16px;">Сравнительная таблица</h3>
                <div style="overflow-x: auto;">
                    <table id="comparisonTableContent" style="width: 100%; border-collapse: collapse;">
                        <!-- Таблица будет заполнена через JS -->
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentMode = 'basic';
        let earlyPayments = [];
        let savedCalculations = [];

        function formatNumber(num) {
            return new Intl.NumberFormat('ru-RU').format(Math.round(num));
        }

        function parseFormattedNumber(str) {
            return parseFloat(str.replace(/[^\d.-]/g, '')) || 0;
        }

        function setValue(inputId, value) {
            document.getElementById(inputId).value = value;
            calculateMortgage();
        }

        function setPercentage(inputId, percent) {
            const propertyPrice = parseFloat(document.getElementById('propertyPrice').value) || 0;
            const value = Math.round(propertyPrice * percent / 100);

            // Показываем сумму рядом с кнопкой
            const button = event.target;
            button.setAttribute('title', formatNumber(value) + ' ₽');

            setValue(inputId, value);
        }

        // Валидация в реальном времени
        function validateInputs() {
            const propertyPrice = parseFloat(document.getElementById('propertyPrice').value) || 0;
            const downPayment = parseFloat(document.getElementById('downPayment').value) || 0;
            const maternalCapital = parseFloat(document.getElementById('maternalCapital').value) || 0;

            const downPaymentField = document.getElementById('downPayment');
            const propertyPriceField = document.getElementById('propertyPrice');

            // Проверка 1: Первоначальный взнос не может быть больше стоимости
            if (downPayment > propertyPrice) {
                downPaymentField.style.borderColor = '#dc3545';
                showWarning('Первоначальный взнос не может превышать стоимость недвижимости');
                return false;
            }

            // Проверка 2: Минимум 15% собственных средств
            const minDownPayment = propertyPrice * 0.15;
            if (downPayment < minDownPayment && propertyPrice > 0) {
                downPaymentField.style.borderColor = '#ffc107';
                showWarning(`Рекомендуется минимум 15% (${formatNumber(minDownPayment)} ₽) первоначального взноса`);
            } else {
                downPaymentField.style.borderColor = '#dee2e6';
                hideWarning();
            }

            // Проверка 3: Стоимость недвижимости в разумных пределах
            if (propertyPrice > 0 && propertyPrice < 500000) {
                propertyPriceField.style.borderColor = '#ffc107';
                showWarning('Слишком низкая стоимость недвижимости. Проверьте введённое значение.');
            } else {
                propertyPriceField.style.borderColor = '#dee2e6';
            }

            return true;
        }

        function showWarning(message) {
            let warningDiv = document.getElementById('validationWarning');
            if (!warningDiv) {
                warningDiv = document.createElement('div');
                warningDiv.id = 'validationWarning';
                warningDiv.style.cssText = 'background: #fff3cd; border: 1px solid #ffc107; color: #856404; padding: 12px 16px; border-radius: 8px; margin: 16px 0; font-size: 14px; display: flex; align-items: center; gap: 8px;';
                const inputsSection = document.querySelector('.inputs');
                inputsSection.insertBefore(warningDiv, inputsSection.children[1]);
            }
            warningDiv.innerHTML = `
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                    <line x1="12" y1="9" x2="12" y2="13"></line>
                    <line x1="12" y1="17" x2="12.01" y2="17"></line>
                </svg>
                ${message}
            `;
            warningDiv.style.display = 'flex';
        }

        function hideWarning() {
            const warningDiv = document.getElementById('validationWarning');
            if (warningDiv) {
                warningDiv.style.display = 'none';
            }
        }

        function switchMode(mode) {
            currentMode = mode;
            const calculatorContainer = document.getElementById('calculatorContainer');
            const modeButtons = document.querySelectorAll('.mode-btn');
            const advancedFeatures = document.querySelectorAll('.advanced-features');

            // Update button states
            modeButtons.forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            // Update layout
            if (mode === 'basic') {
                calculatorContainer.classList.add('basic-mode');
                advancedFeatures.forEach(feature => feature.classList.remove('active'));
            } else {
                calculatorContainer.classList.remove('basic-mode');
                advancedFeatures.forEach(feature => feature.classList.add('active'));
            }

            calculateMortgage();
        }

        function calculateMortgage() {
            // Валидация перед расчётом
            if (!validateInputs()) {
                return; // Прерываем расчёт если валидация не прошла
            }

            // Отправка цели в Яндекс.Метрику
            if (typeof ym !== 'undefined') {
                ym(104341432, 'reachGoal', 'calculation_made', {
                    calculator: 'mortgage'
                });
            }

            const propertyPrice = parseFloat(document.getElementById('propertyPrice').value) || 0;
            const downPayment = parseFloat(document.getElementById('downPayment').value) || 0;
            const maternalCapital = parseFloat(document.getElementById('maternalCapital').value) || 0;
            let interestRate = parseFloat(document.getElementById('interestRate').value) || 0;
            const loanTerm = parseFloat(document.getElementById('loanTerm').value) || 0;
            const paymentType = document.getElementById('paymentType').value;
            const subsidyType = document.getElementById('subsidyType').value;

            // Применяем субсидии к процентной ставке
            if (subsidyType === 'family') {
                interestRate = Math.min(interestRate, 6.0); // Семейная ипотека до 6%
            } else if (subsidyType === 'it') {
                interestRate = Math.min(interestRate, 5.0); // IT-ипотека до 5%
            } else if (subsidyType === 'military') {
                interestRate = 5.9; // Военная ипотека фиксированная ставка
            } else if (subsidyType === 'rural') {
                interestRate = Math.min(interestRate, 3.0); // Сельская ипотека до 3%
            } else if (subsidyType === 'dv') {
                interestRate = Math.min(interestRate, 2.0); // Дальневосточная до 2%
            }

            // Проверка минимального первоначального взноса (15% собственных средств)
            const minDownPaymentPercent = 0.15;
            const minDownPayment = propertyPrice * minDownPaymentPercent;

            if (downPayment < minDownPayment) {
                alert(`Требуется минимум ${Math.round(minDownPaymentPercent * 100)}% (${formatNumber(minDownPayment)} ₽) собственных средств в первоначальном взносе`);
                return;
            }

            // Материнский капитал добавляется к первоначальному взносу
            const totalDownPayment = downPayment + maternalCapital;
            const loanAmount = propertyPrice - totalDownPayment;

            const monthlyRate = interestRate / 100 / 12;
            const numberOfPayments = loanTerm * 12;

            if (loanAmount <= 0 || monthlyRate <= 0 || numberOfPayments <= 0) {
                return;
            }

            let monthlyPayment, totalAmount, totalOverpayment;

            if (paymentType === 'annuity') {
                monthlyPayment = loanAmount * (monthlyRate * Math.pow(1 + monthlyRate, numberOfPayments)) / 
                                 (Math.pow(1 + monthlyRate, numberOfPayments) - 1);
                totalAmount = monthlyPayment * numberOfPayments;
                totalOverpayment = totalAmount - loanAmount;
            } else {
                // Дифференцированный платеж
                const principalPayment = loanAmount / numberOfPayments;
                let totalInterest = 0;
                for (let i = 0; i < numberOfPayments; i++) {
                    const remainingBalance = loanAmount - (principalPayment * i);
                    totalInterest += remainingBalance * monthlyRate;
                }
                monthlyPayment = principalPayment + (loanAmount * monthlyRate); // Первый платеж
                totalAmount = loanAmount + totalInterest;
                totalOverpayment = totalInterest;
            }

            // Update basic result
            document.getElementById('basicMonthlyPayment').textContent = formatNumber(monthlyPayment) + ' ₽';
            document.getElementById('basicLoanAmount').textContent = formatNumber(loanAmount) + ' ₽';
            document.getElementById('basicOverpayment').textContent = formatNumber(totalOverpayment) + ' ₽';

            // Update advanced results
            document.getElementById('monthlyPayment').textContent = formatNumber(monthlyPayment) + ' ₽';
            document.getElementById('loanAmount').textContent = formatNumber(loanAmount) + ' ₽';
            document.getElementById('totalOverpayment').textContent = formatNumber(totalOverpayment) + ' ₽';
            document.getElementById('totalAmount').textContent = formatNumber(totalAmount) + ' ₽';

            if (currentMode === 'advanced') {
                updateAdvancedResults(loanAmount, monthlyPayment, totalAmount, totalOverpayment, monthlyRate, numberOfPayments, paymentType);
            }
        }

        function updateAdvancedResults(loanAmount, monthlyPayment, totalAmount, totalOverpayment, monthlyRate, numberOfPayments, paymentType) {
            // Update breakdown
            const requiredIncome = monthlyPayment / 0.4; // 40% rule
            const firstPaymentInterest = loanAmount * monthlyRate;
            const firstPaymentPrincipal = paymentType === 'annuity' ? monthlyPayment - firstPaymentInterest : loanAmount / numberOfPayments;
            const effectiveRate = (Math.pow(totalAmount / loanAmount, 1 / (numberOfPayments / 12)) - 1) * 100;

            document.getElementById('requiredIncome').textContent = formatNumber(requiredIncome) + ' ₽';
            document.getElementById('firstPaymentPrincipal').textContent = formatNumber(firstPaymentPrincipal) + ' ₽';
            document.getElementById('firstPaymentInterest').textContent = formatNumber(firstPaymentInterest) + ' ₽';
            document.getElementById('effectiveRate').textContent = effectiveRate.toFixed(2) + '%';

            // Update pie chart
            const principalPercent = (loanAmount / totalAmount) * 100;
            const interestPercent = (totalOverpayment / totalAmount) * 100;

            document.getElementById('principalPercent').textContent = principalPercent.toFixed(1) + '%';
            document.getElementById('interestPercent').textContent = interestPercent.toFixed(1) + '%';

            // Update SVG arcs
            const circumference = 2 * Math.PI * 80;
            const principalArcLength = (principalPercent / 100) * circumference;
            const interestArcLength = (interestPercent / 100) * circumference;

            document.getElementById('principalArc').setAttribute('stroke-dasharray', 
                principalArcLength + ' ' + (circumference - principalArcLength));

            document.getElementById('interestArc').setAttribute('stroke-dasharray', 
                interestArcLength + ' ' + (circumference - interestArcLength));
            document.getElementById('interestArc').setAttribute('stroke-dashoffset', -principalArcLength);

            // Update payment schedule
            updatePaymentSchedule(loanAmount, monthlyRate, numberOfPayments, paymentType);
            
            // Update calculation details
            updateCalculationDetails(propertyPrice, downPayment, loanAmount, monthlyRate, numberOfPayments, monthlyPayment, totalOverpayment);
        }

        function updatePaymentSchedule(loanAmount, monthlyRate, numberOfPayments, paymentType) {
            const scheduleBody = document.getElementById('scheduleTableBody');
            scheduleBody.innerHTML = '';

            let remainingBalance = loanAmount;
            
            // Show first 12 months
            for (let month = 1; month <= Math.min(12, numberOfPayments); month++) {
                let payment, principal, interest;

                if (paymentType === 'annuity') {
                    payment = loanAmount * (monthlyRate * Math.pow(1 + monthlyRate, numberOfPayments)) / 
                             (Math.pow(1 + monthlyRate, numberOfPayments) - 1);
                    interest = remainingBalance * monthlyRate;
                    principal = payment - interest;
                } else {
                    principal = loanAmount / numberOfPayments;
                    interest = remainingBalance * monthlyRate;
                    payment = principal + interest;
                }

                remainingBalance -= principal;

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${month}</td>
                    <td>${formatNumber(payment)} ₽</td>
                    <td>${formatNumber(principal)} ₽</td>
                    <td>${formatNumber(interest)} ₽</td>
                    <td>${formatNumber(Math.max(0, remainingBalance))} ₽</td>
                `;
                scheduleBody.appendChild(row);
            }
        }

        // Функции для работы с детализацией расчетов
        function toggleCalculationDetails() {
            const content = document.getElementById('calculationDetailsContent');
            const toggle = document.querySelector('.details-toggle');
            const toggleText = toggle.querySelector('.toggle-text');
            
            if (content.classList.contains('show')) {
                content.classList.remove('show');
                toggle.classList.remove('active');
                toggleText.textContent = 'Показать расчеты';
            } else {
                content.classList.add('show');
                toggle.classList.add('active');
                toggleText.textContent = 'Скрыть расчеты';
            }
        }
        
        function updateCalculationDetails(propertyPrice, downPayment, loanAmount, monthlyRate, numberOfPayments, monthlyPayment, totalOverpayment) {
            // Обновляем расчет суммы кредита
            document.getElementById('loanAmountCalculation').textContent = 
                `${formatNumber(propertyPrice)} - ${formatNumber(downPayment)} = ${formatNumber(loanAmount)} руб.`;
            
            // Обновляем расчет ежемесячного платежа
            document.getElementById('monthlyPaymentCalculation').textContent = 
                `S = ${formatNumber(loanAmount)} руб., i = ${monthlyRate.toFixed(6)}, n = ${numberOfPayments}`;
            
            // Обновляем расчет переплаты
            document.getElementById('overpaymentCalculation').textContent = 
                `(${formatNumber(monthlyPayment)} × ${numberOfPayments}) - ${formatNumber(loanAmount)} = ${formatNumber(totalOverpayment)} руб.`;
        }

        function addEarlyPayment() {
            const month = parseInt(document.getElementById('earlyPaymentMonth').value);
            const amount = parseFloat(document.getElementById('earlyPaymentAmount').value);
            const type = document.getElementById('earlyPaymentType').value;

            if (!month || !amount || month < 1) {
                alert('Пожалуйста, заполните все поля корректно');
                return;
            }

            earlyPayments.push({ month, amount, type });
            updateEarlyPaymentsList();
            
            // Clear inputs
            document.getElementById('earlyPaymentMonth').value = '';
            document.getElementById('earlyPaymentAmount').value = '';
        }

        function updateEarlyPaymentsList() {
            const list = document.getElementById('earlyPaymentsList');
            list.innerHTML = '';

            earlyPayments.forEach((payment, index) => {
                const item = document.createElement('div');
                item.className = 'early-payment-item';
                item.innerHTML = `
                    <span>${payment.month} месяц: ${formatNumber(payment.amount)} ₽ 
                    (${payment.type === 'reduce_term' ? 'уменьшить срок' : 'уменьшить платеж'})</span>
                    <button onclick="removeEarlyPayment(${index})">Удалить</button>
                `;
                list.appendChild(item);
            });
        }

        function removeEarlyPayment(index) {
            earlyPayments.splice(index, 1);
            updateEarlyPaymentsList();
        }

        function resetCalculator() {
            document.getElementById('propertyPrice').value = 8000000;
            document.getElementById('downPayment').value = 2400000;
            document.getElementById('interestRate').value = 8.5;
            document.getElementById('loanTerm').value = 20;
            document.getElementById('paymentType').value = 'annuity';
            earlyPayments = [];
            updateEarlyPaymentsList();
            calculateMortgage();
        }

        function exportToPDF() {
            // Отправка цели в Яндекс.Метрику
            if (typeof ym !== 'undefined') {
                ym(104341432, 'reachGoal', 'pdf_export', {
                    calculator: 'mortgage'
                });
            }

            // Показываем индикатор загрузки
            const loadingOverlay = document.createElement('div');
            loadingOverlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.7);
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                color: white;
                font-size: 18px;
            `;
            loadingOverlay.innerHTML = `
                <div style="text-align: center;">
                    <div style="width: 50px; height: 50px; border: 4px solid #f3f3f3; border-top: 4px solid #4F2CD9; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>
                    <div>Генерируем PDF...</div>
                </div>
            `;
            document.body.appendChild(loadingOverlay);

            // Добавляем анимацию вращения
            if (!document.getElementById('pdfSpinnerStyle')) {
                const spinnerStyle = document.createElement('style');
                spinnerStyle.id = 'pdfSpinnerStyle';
                spinnerStyle.textContent = `
                    @keyframes spin {
                        0% { transform: rotate(0deg); }
                        100% { transform: rotate(360deg); }
                    }
                `;
                document.head.appendChild(spinnerStyle);
            }

            // Даём время на отрисовку индикатора
            setTimeout(() => {
                try {
                    exportMortgageToPDF();
                    document.body.removeChild(loadingOverlay);
                    showNotification('PDF успешно сохранён', 'success');
                } catch (error) {
                    document.body.removeChild(loadingOverlay);
                    showNotification('Ошибка при создании PDF: ' + error.message, 'error');
                    console.error('PDF Export Error:', error);
                }
            }, 100);
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            const bgColor = type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : '#4F2CD9';
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${bgColor};
                color: white;
                padding: 16px 24px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 10001;
                font-size: 14px;
                max-width: 400px;
                animation: slideInRight 0.3s ease-out;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease-out';
                setTimeout(() => notification.remove(), 300);
            }, 4000);

            // Добавляем стили анимации если их ещё нет
            if (!document.getElementById('notificationStyles')) {
                const style = document.createElement('style');
                style.id = 'notificationStyles';
                style.textContent = `
                    @keyframes slideInRight {
                        from {
                            transform: translateX(400px);
                            opacity: 0;
                        }
                        to {
                            transform: translateX(0);
                            opacity: 1;
                        }
                    }
                    @keyframes slideOutRight {
                        from {
                            transform: translateX(0);
                            opacity: 1;
                        }
                        to {
                            transform: translateX(400px);
                            opacity: 0;
                        }
                    }
                `;
                document.head.appendChild(style);
            }
        }

        // Дебаунсинг для оптимизации производительности
        let calculationTimeout;
        function debouncedCalculate() {
            // Добавляем визуальную обратную связь
            document.querySelectorAll('.input-field').forEach(field => {
                if (field === document.activeElement) {
                    field.classList.add('calculating');
                }
            });
            
            clearTimeout(calculationTimeout);
            calculationTimeout = setTimeout(() => {
                calculateMortgage();
                
                // Убираем индикатор загрузки
                document.querySelectorAll('.input-field').forEach(field => {
                    field.classList.remove('calculating');
                });
            }, 150); // Соблюдение порога Доэрти (<400ms)
        }

        // Автосохранение в localStorage
        function saveToLocalStorage() {
            const data = {
                propertyPrice: document.getElementById('propertyPrice').value,
                downPayment: document.getElementById('downPayment').value,
                maternalCapital: document.getElementById('maternalCapital')?.value || 0,
                interestRate: document.getElementById('interestRate').value,
                loanTerm: document.getElementById('loanTerm').value,
                paymentType: document.getElementById('paymentType').value,
                subsidyType: document.getElementById('subsidyType')?.value || 'none',
                timestamp: new Date().toISOString()
            };
            try {
                localStorage.setItem('m2_mortgage_calculator', JSON.stringify(data));
            } catch (e) {
                console.warn('Could not save to localStorage:', e);
            }
        }

        function loadFromLocalStorage() {
            try {
                const saved = localStorage.getItem('m2_mortgage_calculator');
                if (saved) {
                    const data = JSON.parse(saved);
                    // Проверяем, что данные не старше 7 дней
                    const savedDate = new Date(data.timestamp);
                    const daysDiff = (new Date() - savedDate) / (1000 * 60 * 60 * 24);

                    if (daysDiff < 7) {
                        document.getElementById('propertyPrice').value = data.propertyPrice || 8000000;
                        document.getElementById('downPayment').value = data.downPayment || 2400000;
                        if (document.getElementById('maternalCapital')) {
                            document.getElementById('maternalCapital').value = data.maternalCapital || 0;
                        }
                        document.getElementById('interestRate').value = data.interestRate || 8.5;
                        document.getElementById('loanTerm').value = data.loanTerm || 20;
                        document.getElementById('paymentType').value = data.paymentType || 'annuity';
                        if (document.getElementById('subsidyType')) {
                            document.getElementById('subsidyType').value = data.subsidyType || 'none';
                        }
                    }
                }
            } catch (e) {
                console.warn('Could not load from localStorage:', e);
            }
        }

        // Event listeners с дебаунсингом и автосохранением
        function debouncedCalculateWithSave() {
            debouncedCalculate();
            saveToLocalStorage();
        }

        document.getElementById('propertyPrice').addEventListener('input', debouncedCalculateWithSave);
        document.getElementById('downPayment').addEventListener('input', debouncedCalculateWithSave);
        document.getElementById('interestRate').addEventListener('input', debouncedCalculateWithSave);
        document.getElementById('loanTerm').addEventListener('input', debouncedCalculateWithSave);
        document.getElementById('paymentType').addEventListener('change', () => {
            calculateMortgage();
            saveToLocalStorage();
        });

        if (document.getElementById('maternalCapital')) {
            document.getElementById('maternalCapital').addEventListener('input', debouncedCalculateWithSave);
        }
        if (document.getElementById('subsidyType')) {
            document.getElementById('subsidyType').addEventListener('change', () => {
                calculateMortgage();
                saveToLocalStorage();
            });
        }

        // Initial load and calculation
        loadFromLocalStorage();
        calculateMortgage();
        
        // ===== ФУНКЦИИ СРАВНЕНИЯ ВАРИАНТОВ =====
        function openCompareModal() {
            // Отправка цели в Яндекс.Метрику
            if (typeof ym !== 'undefined') {
                ym(104341432, 'reachGoal', 'comparison_opened', {
                    calculator: 'mortgage'
                });
            }

            document.getElementById('compareModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
            renderSavedCalculations();
        }

        function closeCompareModal() {
            document.getElementById('compareModal').style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        function saveCurrentCalculation() {
            if (savedCalculations.length >= 3) {
                alert('Максимум 3 варианта. Удалите один из существующих вариантов.');
                return;
            }

            const propertyPrice = parseFloat(document.getElementById('propertyPrice').value) || 0;
            const downPayment = parseFloat(document.getElementById('downPayment').value) || 0;
            const interestRate = parseFloat(document.getElementById('interestRate').value) || 0;
            const loanTerm = parseFloat(document.getElementById('loanTerm').value) || 0;
            const monthlyPayment = parseFloat(document.getElementById('basicMonthlyPayment')?.textContent.replace(/[^\d]/g, '')) || 0;
            const totalOverpayment = parseFloat(document.getElementById('basicOverpayment')?.textContent.replace(/[^\d]/g, '')) || 0;

            const calculation = {
                id: Date.now(),
                label: `Вариант ${savedCalculations.length + 1}`,
                propertyPrice,
                downPayment,
                loanAmount: propertyPrice - downPayment,
                interestRate,
                loanTerm,
                monthlyPayment,
                totalOverpayment,
                timestamp: new Date().toLocaleString('ru-RU')
            };

            savedCalculations.push(calculation);
            renderSavedCalculations();
            showNotification('Вариант добавлен для сравнения', 'success');
        }

        function removeCalculation(id) {
            savedCalculations = savedCalculations.filter(calc => calc.id !== id);
            renderSavedCalculations();
        }

        function renderSavedCalculations() {
            const grid = document.getElementById('compareGrid');
            const table = document.getElementById('comparisonTable');
            const tableContent = document.getElementById('comparisonTableContent');

            if (savedCalculations.length === 0) {
                grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: #666; padding: 40px;">Нет сохранённых вариантов. Добавьте текущий расчёт для сравнения.</div>';
                table.style.display = 'none';
                return;
            }

            // Рендерим карточки
            grid.innerHTML = savedCalculations.map(calc => `
                <div style="background: #F6F5FF; border: 2px solid #4F2CD9; border-radius: 12px; padding: 20px; position: relative;">
                    <button onclick="removeCalculation(${calc.id})" style="position: absolute; top: 10px; right: 10px; background: #dc3545; color: white; border: none; border-radius: 50%; width: 28px; height: 28px; cursor: pointer; font-size: 18px; line-height: 1;">×</button>

                    <h3 style="color: #4F2CD9; margin-bottom: 16px; font-size: 18px;">${calc.label}</h3>

                    <div style="font-size: 13px; color: #666; margin-bottom: 12px;">${calc.timestamp}</div>

                    <div style="margin-bottom: 8px;"><strong>Стоимость:</strong> ${formatNumber(calc.propertyPrice)} ₽</div>
                    <div style="margin-bottom: 8px;"><strong>Взнос:</strong> ${formatNumber(calc.downPayment)} ₽</div>
                    <div style="margin-bottom: 8px;"><strong>Кредит:</strong> ${formatNumber(calc.loanAmount)} ₽</div>
                    <div style="margin-bottom: 8px;"><strong>Ставка:</strong> ${calc.interestRate}%</div>
                    <div style="margin-bottom: 8px;"><strong>Срок:</strong> ${calc.loanTerm} лет</div>
                    <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #4F2CD9;">
                        <div style="font-size: 16px; color: #4F2CD9; font-weight: bold;">${formatNumber(calc.monthlyPayment)} ₽/мес</div>
                        <div style="font-size: 13px; color: #666;">Переплата: ${formatNumber(calc.totalOverpayment)} ₽</div>
                    </div>
                </div>
            `).join('');

            // Рендерим сравнительную таблицу
            if (savedCalculations.length > 1) {
                table.style.display = 'block';
                tableContent.innerHTML = `
                    <thead style="background: #4F2CD9; color: white;">
                        <tr>
                            <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Параметр</th>
                            ${savedCalculations.map(calc => `<th style="padding: 12px; text-align: center; border: 1px solid #ddd;">${calc.label}</th>`).join('')}
                        </tr>
                    </thead>
                    <tbody>
                        <tr style="background: #f8f9fa;">
                            <td style="padding: 12px; font-weight: bold; border: 1px solid #ddd;">Ежемесячный платёж</td>
                            ${savedCalculations.map(calc => `<td style="padding: 12px; text-align: center; border: 1px solid #ddd; font-weight: bold; color: #4F2CD9;">${formatNumber(calc.monthlyPayment)} ₽</td>`).join('')}
                        </tr>
                        <tr>
                            <td style="padding: 12px; border: 1px solid #ddd;">Переплата</td>
                            ${savedCalculations.map(calc => `<td style="padding: 12px; text-align: center; border: 1px solid #ddd;">${formatNumber(calc.totalOverpayment)} ₽</td>`).join('')}
                        </tr>
                        <tr style="background: #f8f9fa;">
                            <td style="padding: 12px; border: 1px solid #ddd;">Сумма кредита</td>
                            ${savedCalculations.map(calc => `<td style="padding: 12px; text-align: center; border: 1px solid #ddd;">${formatNumber(calc.loanAmount)} ₽</td>`).join('')}
                        </tr>
                        <tr>
                            <td style="padding: 12px; border: 1px solid #ddd;">Процентная ставка</td>
                            ${savedCalculations.map(calc => `<td style="padding: 12px; text-align: center; border: 1px solid #ddd;">${calc.interestRate}%</td>`).join('')}
                        </tr>
                        <tr style="background: #f8f9fa;">
                            <td style="padding: 12px; border: 1px solid #ddd;">Срок кредита</td>
                            ${savedCalculations.map(calc => `<td style="padding: 12px; text-align: center; border: 1px solid #ddd;">${calc.loanTerm} лет</td>`).join('')}
                        </tr>
                    </tbody>
                `;
            } else {
                table.style.display = 'none';
            }
        }

        // ===== ЭКСПОРТ В EXCEL/CSV =====
        function exportToExcel() {
            // Отправка цели в Яндекс.Метрику
            if (typeof ym !== 'undefined') {
                ym(104341432, 'reachGoal', 'excel_export', {
                    calculator: 'mortgage'
                });
            }

            const propertyPrice = parseFloat(document.getElementById('propertyPrice').value) || 0;
            const downPayment = parseFloat(document.getElementById('downPayment').value) || 0;
            const interestRate = parseFloat(document.getElementById('interestRate').value) || 0;
            const loanTerm = parseFloat(document.getElementById('loanTerm').value) || 0;
            const loanAmount = propertyPrice - downPayment;
            const monthlyPayment = parseFloat(document.getElementById('basicMonthlyPayment')?.textContent.replace(/[^\d]/g, '')) || 0;
            const totalOverpayment = parseFloat(document.getElementById('basicOverpayment')?.textContent.replace(/[^\d]/g, '')) || 0;

            // Создаём CSV контент
            let csvContent = '\uFEFF'; // BOM для корректного отображения кириллицы в Excel
            csvContent += 'М2 - Ипотечный калькулятор\n';
            csvContent += `Дата расчёта,${new Date().toLocaleString('ru-RU')}\n\n`;

            csvContent += 'Параметры расчёта\n';
            csvContent += 'Параметр,Значение\n';
            csvContent += `Стоимость недвижимости,${formatNumber(propertyPrice)} ₽\n`;
            csvContent += `Первоначальный взнос,${formatNumber(downPayment)} ₽\n`;
            csvContent += `Сумма кредита,${formatNumber(loanAmount)} ₽\n`;
            csvContent += `Процентная ставка,${interestRate}%\n`;
            csvContent += `Срок кредита,${loanTerm} лет\n\n`;

            csvContent += 'Результаты расчёта\n';
            csvContent += 'Показатель,Значение\n';
            csvContent += `Ежемесячный платёж,${formatNumber(monthlyPayment)} ₽\n`;
            csvContent += `Переплата по кредиту,${formatNumber(totalOverpayment)} ₽\n`;
            csvContent += `Общая сумма выплат,${formatNumber(loanAmount + totalOverpayment)} ₽\n\n`;

            // Создаём blob и скачиваем
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);

            link.setAttribute('href', url);
            link.setAttribute('download', `m2_ипотека_${new Date().getTime()}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showNotification('Excel файл успешно загружен', 'success');
        }

        // Register Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js');
        }
    </script>
    <script src="apply-m2-theme.js"></script>
<script src="m2-layout.js"></script>
</body>
</html>